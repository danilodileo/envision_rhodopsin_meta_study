---
title: "Prelimiary analysis of ENVISION dataset"
author: "[Danilo Di Leo](https://github.com/danilodileo)"
date: today
format:
  html:
    toc: true
    toc-title: "Table of Contents"
    toc-depth: 2
    toc-location: left
    number-sections: true
    code-fold: true
    code-summary: "Show Code"
    fig-width: 6
    fig-height: 4
    highlight-style: github
    self-contained: true  
editor: visual
bibliography:
  - grateful-refs.bib
---

```{r setup}
#| label: setup
#| echo: false
#| cache: true

knitr::opts_chunk$set(echo = TRUE, fig.path='figures/', cache = TRUE, fig.width = 10)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries}
#| label: libraries
#| message: false
#| cache: false
#| include: false

library(readr)
library(dplyr, warn.conflicts = FALSE)
library(tidyr)
library(lubridate)
library(purrr)
library(stringr)
library(ggplot2)
library(ggrepel)
library(kfigr)
library(knitr)
library(DT)
library(grateful)
library(patchwork)
library(broom)
library(gt)
library(tibble)
library(corrr)
library(forcats)
library(shiny)
library(grid)
library(ggvenn)
library(vegan)
library(reshape2)
library(ggsignif)
library(readxl)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(missMDA)
library(kableExtra) # For tables
library(compositions) # For CLR transformation
```

```{r read-data, cache.lazy=FALSE}
#| label: read-data
#| echo: false

# ALL DATA USED IN THIS ANALYSIS WERE ORIGINALLY FROM
# magmap.output.k31.all.samples/summary_tables

# load counts table
# counts <- read_tsv(
#   'magmap.output.k31.all.samples/summary_tables/magmap.all_samples.counts.tsv.gz',
#   col_types = cols(
#     .default = col_double(), orf = col_character(), chr = col_character(),
#    sample = col_character(), strand = col_character()
#     )) %>%
#   select( -start, -end, -chr, -strand)

# I need to get the average for the mesocosm samples
# Step 1: Process `M` triplicates
# triplicates <- counts %>%
#   filter(str_detect(sample, "_M[0-3]$")) %>%
#   mutate(sample = str_remove(sample, "_M[0-3]$") %>% paste0("_M")) %>%
#   group_by(orf, length, sample) %>%
#   summarize(
#     count   = mean(count),
#     tpm     = mean(tpm),
#     sdcount = sd(count),
#     sdtpm   = sd(tpm), .groups = 'drop')

  
# Step 2: Combine with the original dataframe
# counts <- counts %>%
#   filter(!str_detect(sample, "_M[0-3]$")) %>%  # Keep non-triplicate samples
#   mutate( sdcount = 0,
#           sdtpm   = 0) %>%
#   arrange(count, sdcount, tpm, sdtpm) %>%
#   bind_rows(triplicates)

# rm(triplicates)

# bind counts with genomes_index + formatting the table
# counts <- counts %>%
#   mutate(
#     season = case_when(
#     startsWith(sample, "ENV1") ~ "Winter",
#     startsWith(sample, "ENV2") ~ "Spring",
#       startsWith(sample, "ENV3") ~ "Summer",
#       TRUE ~ "Unknown"  # Optional: label for cases that don't match any pattern
#     ),
#     season = factor(season, levels = c("Winter", "Spring", "Summer")),
#     site = case_when(
#       str_detect(sample, "S3") ~ "Coast",      # When "S3" is present
#       str_detect(sample, "S6") ~ "Offshore",   # When "S6" is present
#       str_detect(sample, "M") ~ "Mesocosm",   # When "M" is present
#       TRUE ~ "Other"                          # Optional: for any other case
#     ),
#     site = factor(site, levels = c("Offshore", "Coast", "Mesocosm"))
#   ) %>%
#   left_join(
#     read_tsv(
#       './magmap.output.k31.all.samples/summary_tables/genomes_index.gz', # load genome index for taxonomy annotation
#       show_col_types = FALSE
#     ) %>%
#     rename(
#       orf = 'ID', accession = 'accno'
#       )
#     , by = "orf"
#     )

# load metadata for genomes taxonomy
# load_and_clean_taxonomy <- function(file, accession_col, taxonomy_col) {
#   read_tsv(file, id = 'fname', show_col_types = FALSE) %>%
#     select(!!sym(accession_col), !!sym(taxonomy_col)) %>%
#     mutate(
#       !!sym(accession_col) := str_replace(!!sym(accession_col), ".*(GCF|GCA)", "\\1"),
#       !!sym(accession_col) := str_replace(!!sym(accession_col), ".fa|_sub", "")
#     ) %>%
#     rename(accession = !!sym(accession_col), gtdb_taxonomy = !!sym(taxonomy_col)) %>%
#     separate(gtdb_taxonomy,
#              into = c("domain", "phylum", "class", "order", "family", "genus", "species"),
#              sep = ";", remove = FALSE) %>%
#     mutate(across(domain:species, ~ str_replace(., "^[d-pcfogs]__", ""))) %>%
#     select(-gtdb_taxonomy)
# }

# # Add taxonomy to the main counts table
# counts <- bind_rows(
#   Sys.glob('*r214.tsv.gz') %>% load_and_clean_taxonomy("accession", "gtdb_taxonomy"),
#   Sys.glob('*.summary.tsv.gz') %>% load_and_clean_taxonomy("user_genome", "classification")
#   ) %>%
#   right_join(counts, join_by(accession)) %>%
#   select(-accession)

# Read eggnog mapper annotation
# create a cog_mapping variable
# cog_mapping <- c(
#   'A' = 'RNA_process',
#   'B' = 'Chromatin_Struc',
#   'C' = 'Energy_prod',
#   'D' = 'Cell_cycle',
#   'E' = 'AA_metab',
#   'F' = 'Nucl_metab',
#   'G' = 'Carbohy_metab',
#   'H' = 'Coenz_metab',
#   'I' = 'Lipid_metab',
#   'J' = 'Tranlsation',
#   'K' = 'Transcription',
#   'L' = 'Replication',
#   'M' = 'Cell_wall',
#   'N' = 'Cell_motility',
#   'O' = 'Post-transl_mod',
#   'P' = 'Inorg_ion_transp',
#   'Q' = 'Sec_Structure',
#   'T' = 'Signal_Transduc',
#   'U' = 'Intracel_traf',
#   'Y' = 'Nucl_structure',
#   'Z' = 'Cytoskeleton',
#   'R' = 'Gen_Func',
#   'S' = 'Func_unknown',
#   '-' = 'Func_unknown'
# )
# 
# # spot which files have different number of columns
# files <- Sys.glob('magmap.output.k31.all.samples/summary_tables/emapper/*annotations.gz')
# 
# # Function to count columns in each file
# count_columns <- function(file) {
#   num_cols <- read_tsv(file, comment = "##", show_col_types = FALSE) %>%
#     ncol()
#   tibble(file = file, num_cols = num_cols)
# }
# 
# # Apply the function to each file and collect the results
# file_column_counts <- map_dfr(files, count_columns)
# 
# # Pull files with 21 columns
# file.with.21.columns <- file_column_counts %>%
#   filter( num_cols == 21) %>%
#   select(-num_cols) %>%
#   pull(file)

# 
# # Pull files with 24 columns
# file.with.24.columns <- file_column_counts %>%
#   filter( num_cols == 24) %>%
#   select(-num_cols) %>%
#   pull(file)
# 
# # Add functional annotation to the main counts table
# counts <-  rbind(
#   file.with.24.columns %>% # load all annotated ORFs
#     read_tsv(id = 'fname', comment = "##", show_col_types = FALSE) %>%
#     rename_with(~ tolower(sub("^#", "", .)))  %>%
#     rename( orf = 'query',
#           max_annot_lvl = 'best_og_name',
#           cog_category = 'best_og_cat',
#           description = 'best_og_desc') %>%
#     mutate( project = 'gtdb') %>%
#     select(-fname, -narr_og_name, -narr_og_cat, -narr_og_desc),
#   file.with.21.columns %>%
#     read_tsv(id = 'fname', comment = "##", show_col_types = FALSE) %>%
#     rename_with(~ tolower(sub("^#", "", .)))  %>%
#     rename( orf = 'query') %>%
#     mutate( project = 'gtdb') %>%
#     select(-fname),
#   Sys.glob('magmap.output.k31.all.samples/summary_tables/emapper-local-genomes/*') %>%
#     read_tsv(id = 'fname', show_col_types = FALSE, comment = "##") %>%
#     rename_with(~ tolower(sub("^#", "", .))) %>%
#     rename( orf = 'query') %>%
#     mutate( project = 'local-genomes') %>%
#     select(-fname)) %>%
#   mutate(cog_category = recode(cog_category, !!!cog_mapping)) %>%
#   right_join(counts, join_by(orf)) %>%
#   mutate( site = factor(site, levels = c("Offshore", "Coast", "Mesocosm"))) %>%
#   mutate( season = factor(season, levels = c("Winter", "Spring", "Summer")))

# remove all unused variables
# rm(file_column_counts)
# 
# # Add kofamsscan
# files <- Sys.glob('magmap.output.k31.all.samples/summary_tables/kofamscan/*')
# kofam <- read_tsv(files, col_types = 'cccdddc') %>%
#   select(-"#")
# 
# kofam <- kofam[-1,]

# kofam <- kofam %>%
#   rename( orf = "gene name") %>%
#   rename( evalue = "E-value") %>%
#   filter(evalue < 0.05)

# kofam <- kofam %>%
#   group_by(orf) %>%
#   arrange(desc(score)) %>%  # Sort by score (desc) and then evalue (asc)
#   slice(1) %>%  # Take the first row per group
#   ungroup() %>%
#   select(-score, -evalue, -thrshld)

# Join kofamscan with counts
# counts <- counts %>%
#   left_join(kofam, join_by(orf))  %>%
# mutate(
#   day = case_when(
#     str_detect(sample, "D0") ~ 0,
#     str_detect(sample, "D1") ~ 1,
#     str_detect(sample, "D3") ~ 3,
#     str_detect(sample, "D5") ~ 5,
#     str_detect(sample, "D7") ~ 7,
#     TRUE ~ NA  # Optional: label for cases that don't match any pattern
#     )
# )
# 
# rm(kofam)
# write_tsv(counts, "magmap.output.k31.all.samples/summary_tables/count-tables/magmap.output.full.table.tsv.gz")

# load stats
stats <- read_tsv(
  'data/magmap.overall_stats.tsv.gz',
  col_types = cols(
    .default = col_double(), sample = col_character()
    )
  ) %>%
  group_by(sample) %>%
  mutate(mapping_rate = (idxs_n_mapped*100)/n_non_contaminated,
         depletion_rate = 100 -((n_non_contaminated*100)/n_trimmed))

# Read count table
# counts <- read_tsv('magmap.output.k31.all.samples/summary_tables/count-tables/magmap.output.full.table.tsv.gz', show_col_types = FALSE)

# Subset rhodopsin-containing genomes
# counts.rhodo.genomes <- counts %>%
#   mutate(KO = if_else(str_detect(pfams, "Bac_rhodopsin"), "K04641", KO),
#          KO = if_else(str_detect(KO, "K04641"), "K04643", KO),
#          KO = if_else(str_detect(KO, "K13759"), "K04643", KO),
#          preferred_name = if_else(str_detect(KO, "K04643"), "prd", preferred_name)) %>%
#   filter(preferred_name == 'prd') %>%
#   distinct(genome) %>%
#   inner_join(counts, join_by(genome)) %>%
#   mutate(KO = if_else(str_detect(pfams, "Bac_rhodopsin"), "K04641", KO),
#          KO = if_else(str_detect(KO, "K04641"), "K04643", KO),
#          KO = if_else(str_detect(KO, "K13759"), "K04643", KO),
#          preferred_name = if_else(str_detect(KO, "K04643"), "prd", preferred_name))
# 
# write_tsv(counts.rhodo.genomes, "magmap.output.k31.all.samples/summary_tables/count-tables/magmap.output.rhodopsin.genomes.full.table.tsv.gz")

counts.rhodo.genomes <- read_tsv('data/magmap.output.rhodopsin.genomes.full.table.tsv.gz', show_col_types = FALSE)
# Load meatadata Coast and Offshore
metadata <- read_excel("data/metatada_summarized.xlsx")

# Load metadata Mesocosm
metadata <- read_excel("data/metadata_summarized_mesocosm.xlsx") %>%
  mutate(sample = str_remove(sample, "_M[0-3]$") %>% paste0("_M")) %>%
  group_by(sample, day) %>%
  summarize(across(everything(), ~ if (is.numeric(.)) mean(., na.rm = TRUE) else first(.)), .groups = "drop") %>%
  rbind(metadata) %>%
  left_join( counts.rhodo.genomes %>% dplyr::select(sample, site, season) %>% distinct(sample, .keep_all = TRUE), join_by(sample))
```

# Preliminary Analysis

```{r fig-mapping-depletion-rate}
#| label: fig-mapping-rate
#| fig-cap: '**Mapping rate of samples based on magmap output**'
#| fig-height: 6.5
#| warning: false
#| include: false

# build function to plot deplation rate and mapping rate

# remove proportion of reads from metatdenovo output
p0 <- stats %>%
  pivot_longer(cols = 7:ncol(.), names_to = 'mapdep', values_to = 'proportion') %>%
  ggplot(aes(x = sample, y = proportion, color = mapdep)) +
  geom_point(size = 2, alpha = 0.7) +  # Slightly larger points with transparency
  labs(
    title = "Depletion Rate by Sample",
    x = "Sample",
    y = "Proportion (%)"
  ) +
  theme_light() +
  scale_color_viridis_d() +  # A color-blind-friendly palette
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    axis.text.y = element_text(hjust = 1, size = 6),
    strip.text = element_text(face = "bold", size = 10, color = "white"),
    strip.background = element_rect(fill = "gray20", color = "black"),
    legend.title = element_blank(),
    legend.position = c(1, 0.9)
  ) +
  facet_wrap(~mapdep, scales = 'free_x') +
  coord_flip()

cor_test <- cor.test(stats$mapping_rate, stats$depletion_rate, method = "pearson")  # Use "spearman" if data is not normally distributed

# Extract key statistics
cor_coeff <- round(cor_test$estimate, 3)
p_value <- formatC(cor_test$p.value, format = "e", digits = 2)
conf_low <- round(cor_test$conf.int[1], 3)
conf_high <- round(cor_test$conf.int[2], 3)

# Create a table that shows output from correlation test
t0 <- cor_test %>%
  broom::tidy() %>%
  gt() %>%
  tab_header(
    title = "Correlation Test Results",
    subtitle = "Pearson Correlation between Mapping Rate and Depletion Rate"
  ) %>%
  fmt_number(
    columns = vars(estimate, statistic, p.value, conf.low, conf.high),
    decimals = 3
  ) %>%
  cols_label(
    estimate = "Correlation Coefficient",
    statistic = "t-value",
    p.value = "p-value",
    conf.low = "95% CI Lower",
    conf.high = "95% CI Upper"
  ) %>%
  tab_options(
    table.font.size = "medium"
  )

# plot correlation graph
p1 <- ggplot(stats, aes(x = stats$mapping_rate, y = stats$depletion_rate)) +
    geom_point() +
    geom_smooth(method = "lm", col = "blue") +
    labs(title = "Correlation between Mapping Rate and Depletion Rate",
         x = "Mapping Rate",
         y = "Depletion Rate",) +
    theme_minimal() +
  annotate(
    "text",
    x = Inf, y = Inf, hjust = 1.1, vjust = 1.2,
    label = paste0(
      "Correlation Coefficient: ", cor_coeff, "\n",
      "p-value: ", p_value, "\n",
      "95% CI: [", conf_low, ", ", conf_high, "]"
    ),
    size = 4, color = "black"
  ) +
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = "bold"))

p0 | p1
```

In this section I will explore the ENVISION dataset for the rhodopsin-containing-genomes subset.

1\. Relative abundance of genomes-containing-rhodopsin

2\. NMDS plot based on the genomes

3\. NMDS plot from only rhodopsin protein

4\. Plot taxonomy and rhodopsin transcript distribution

5\. Heatmap comparison 50 most abundant genomes containing rhodopsin and rhodopsin variation within the genomes.

6\. Correlation analysis with rhodopsin and environmental variables.

7\. Take home message from exploration analysis.

8\. New action, next analysis.

9\. Supplementary figures.

## Relative abundance of genomes-containing-rhodopsin

```{r fig-genomes-containing-rhodopsin}
#| label: fig-genomes-containing-rhodopsin
#| fig-cap: '**Abundance of 403 rhodopsin-containing Genomes Across Seasons**: Boxplot showing the total abundance (TPM) of 403 rhodopsin-containing genomes across seasons and grouped by site. Outliers are marked in red. The plot highlights variations in genome abundance across seasons and sites.'
#| fig-height: 6
#| fig-width: 8
#| warning: false

# Showing trends for genomes containing rhodopsin throughout seasons
p3 <- counts.rhodo.genomes %>%
    group_by(sample, season, site) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  ggplot(aes(x = factor(season, levels = c("Winter", "Spring", "Summer")), y = sum_tpm, fill = factor(site, levels = c("Offshore", "Coast", "Mesocosm")))) +
  geom_boxplot(outlier.color = "red", outlier.shape = 1) +
  labs(
    title = "Abundance of 403 rhodopsin-containing Genomes Across Seasons",
    subtitle = "Variation in Rhodopsin Expression by Site and Seasons",
    x = "Season",
    y = "Abundance (TPM)"
  ) +
  labs(fill = "site") +
  theme_minimal()

p3
```

As showed in @fig-genomes-containing-rhodopsin, rhodopsin genomes tend to become more abundant the towards the summer and while in winter they show differences in the different sites, during the summer and spring their abundance it quite similar. To have a better idea of genome distribution, I examined how different genomes contribute to rhodopsin expression by summing TPM (transcripts per million) values across genomes and families for the prd gene ( @fig--cumulative-Contribution-to-Rhodopsin). The plot shows how 100 genomes contributes for the majority of rhodopsin transcripts.

### Cumulative contribution of Genomes to Rhodopsin transcripts

```{r fig-cumulative-Contribution-to-Rhodopsin }
#| label: fig-cumulative-Contribution-to-Rhodopsin
#| fig-cap: '**Cumulative contribution of genomes to rhodopsin expression.** The x-axis represents the number of genomes ranked by their rhodopsin expression level, while the y-axis shows the cumulative percentage of total rhodopsin TPM. The red dashed lines indicate that 100 genomes contribute to ~80% of rhodopsin expression, highlighting that a small subset of genomes accounts for the majority of expression (out of 403 genomes).'  
#| warning: false
x <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  group_by(genome, family) %>%
  summarise( sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate( perc = sum_tpm/sum(sum_tpm)) %>%
  slice_max(sum_tpm, n = 25)

# 6% of genomes express 50% of total rhodopsin
# 12% of genomes express 70% of total rhodopsin

# Prepare data
df_plot <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  group_by(genome, family) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  arrange(desc(sum_tpm)) %>%
  mutate(perc = sum_tpm / sum(sum_tpm) * 100) %>%
  mutate(cum_perc = cumsum(perc), 
         rank = row_number())

# Plot
ggplot(df_plot, aes(x = rank, y = cum_perc)) +
  geom_line(color = "blue", size = 1.2) +
  geom_point(size = 2) +
  geom_hline(yintercept = 84, linetype = "dashed", color = "red") + # 84% reference
  geom_vline(xintercept = 100, linetype = "dashed", color = "red") + # 100 genomes reference
  labs(x = "Number of Genomes", 
       y = "Cumulative % of Rhodopsin Expression",
       title = "Cumulative Contribution of Genomes to Rhodopsin Expression") +
  theme_minimal()

```

## NMDS plots

```{r calc-nmds }
#| label: calc-nmds
#| include: false
#| echo: false
# nmds only for rhodopsin
rhodo.nmds <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  #filter( pfams == 'Bac_rhodopsin') %>%
  group_by(sample, genome) %>%
  summarise(tpm = sum(tpm), .groups = 'drop') %>%
    pivot_wider(names_from = genome, values_from = tpm, values_fill = 0, values_fn = sum) %>%
    as.data.frame() %>%
    tibble::column_to_rownames('sample') %>%
    vegan::metaMDS(try = 50, trymax = 50)

# nmds for the 369 genomes containing rhodopsin
genome.nmds <- counts.rhodo.genomes %>%
  group_by(sample, genome) %>%
  summarise(tpm = sum(tpm), .groups = 'drop') %>%
    pivot_wider(names_from = genome, values_from = tpm, values_fill = 0, values_fn = sum) %>%
    as.data.frame() %>%
    tibble::column_to_rownames('sample') %>%
    vegan::metaMDS(try = 50, trymax = 50)

```

### NMDS plot based on the genomes

```{r fig-nmds}
#| label: fig-nmds
#| fig-cap: '**NMDS of samples based on prokaryotes:** TPM values were summed per genome per sample, while missing values were filled with zero. No transformation (e.g., log, CLR) was applied before running metaMDS() but the counts are normalized in TPM for the whole dataset (included genomes that do not contain rhodopsin). Data was converted into a distance matrix using Bray-Curtis dissimilarity (default in metaMDS). Trymax = 50: Up to 50 random starts to avoid local minima.'
#| warning: false
#| fig-width: 8

p16 <- genome.nmds$points %>%
  as.data.frame() %>%
  tibble::rownames_to_column('sample') %>%
  inner_join(counts.rhodo.genomes, by = join_by(sample)) %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = site, fill = season )) +
  geom_point( size = 2, alpha = 0.3) +
  scale_shape_manual(values = c(21, 22, 23)) +  # Customize shape types if needed
  scale_fill_manual(values = c("green", "red", "blue")) +
  ggforce::geom_mark_ellipse(aes(fill = season), color = NA, alpha = 0.3) +
  annotate("text", x = min(genome.nmds$points[,1]), y = min(genome.nmds$points[,2]), 
           label = paste("Stress =", round(genome.nmds$stress, 3)), hjust = 0, size = 5) +
  geom_text(aes(label = sample), size = 2, check_overlap = TRUE, color = "black", nudge_y = 0.02, nudge_x = 0.02) +  # Add sample names 
  labs( title = "NMDS on 403 genomes containing rhodopsin in Mesocosm ENVISION dataset")
p16
```

As showed in @fig-nmds-only-rhodo, spatial separation between genomes occur through both sites and seasons with remarkable differences when it come to only season (greater distance between Coast Summer and Offshore Winter). Despite eigen value of 0.101 and a Shepard stress plot ( @fig-stressplot-genome ) that confirmed the strenght of the analysis (R\^2 \> 0.9), the dissimilarity between samples is low, suggesting that the samples might have similar community composition, this is also confirmed by the ordination plot ( @fig-ordination-plots A). Cross-analysis with Venn diagram to find unique genomes in the samples, failed (@fig-presence-unique-genomes).

### NMDS plot from only rhodopsin protein

```{r fig-nmds-only-rhodo}
#| label: fig-nmds-only-rhodo
#| fig-cap: '**NMDS of samples based on prokaryotes:** TPM values for **rhodopsin only** were summed per genome per sample, while missing values were filled with zero. No transformation (e.g., log, CLR) was applied before running metaMDS() but the counts are normalized in TPM for the whole dataset (included genomes that do not contain rhodopsin). Data was converted into a distance matrix using Bray-Curtis dissimilarity (default in metaMDS). Trymax = 50: Up to 50 random starts to avoid local minima.'
#| warning: false
#| fig-width: 8

p15 <- rhodo.nmds$points %>%
  as.data.frame() %>%
  tibble::rownames_to_column('sample') %>%
  inner_join(counts.rhodo.genomes, by = join_by(sample)) %>%
  ggplot(aes(x = MDS1, y = MDS2, shape = site, fill = season )) +
  geom_point( size = 2, alpha = 0.3) +
  scale_fill_manual(values = c("green", "red", "blue")) +
  ggforce::geom_mark_ellipse(aes(fill = season), color = NA, alpha = 0.3) +
  annotate("text", x = min(rhodo.nmds$points[,1]), y = min(rhodo.nmds$points[,2]), 
           label = paste("Stress =", round(rhodo.nmds$stress, 3)), hjust = 0, size = 5) +
  geom_text(aes(label = sample), size = 2, check_overlap = TRUE, color = "black", nudge_y = 0.02, nudge_x = 0.02) +  # Add sample names 
  labs( title = "NMDS rhodopsin gene variation in Mesocosm ENVISION dataset")
p15
```

In @fig-nmds-only-rhodo major dissimilarity between winter and summer but with stronger effect compared to the genome-level. Sites cluster closely within the season with major divergence during summer (outliers from summer mesocosm). In MDS1 there is a direction, from left to the right. this is indicating a succession in community composition (not in WHO is there but more WHAT they express) as we could assess from the previous NMDS. Both stressplot and ordination plots can be found in @fig-stressplot-rhodopsin and @fig-ordination-plots B. Since we see many similarities between the two plots: can we say that rhodopsin expression is a proxy for genomes abundance? as shown in @fig-rhodopsin-family-level, it's not true overall, but it might be true at genome level?

```{r fig-overall-taxonomy}
#| label: fig-overall-taxonomy
#| fig-cap: '**Overall Taxonomy**'
#| fig-height: 15
#| warning: false
#| include: false
#| eval: false

# recalculate tpm for only known community
counts <- counts %>%
  filter( domain %in% c('Archaea', 'Bacteria')) %>%
  select(-tpm) %>%
  mutate(r = count/length) %>%
  group_by(sample) %>%
  mutate(tpm = r/sum(r) * 1e6) %>%
  ungroup() %>%
  select(-r) %>%
  as_tibble()

# Overall taxonomy picture by family
# do the same as before for taxonomy
# top 12 taxa
top.overall.tax <- counts %>%
  group_by(family) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  filter( family != 'NA') %>%
  slice_max(sum_tpm, n = 12)

# plot taxonomy
p2 <- counts %>%
  inner_join(top.overall.tax, by = 'family') %>%
  group_by(sample, domain,family, season, site) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  ggplot(aes(x = sample, y = sum_tpm, fill = family)) +
  geom_col(colour = 'black', position = 'fill', size = 0.1) +  # Stacked bars with black borders
  scale_fill_brewer(palette = 'Paired') +
  labs(
    title = "TPM Proportions by family Across Samples",
    x = "Sample",
    y = "Proportional TPM",
    fill = "family"
  ) +
  theme_minimal() +  # Clean, modern theme
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Centered title
    axis.text.x = element_text(angle = 45, hjust = 1, size = 5),  # Rotate x-axis labels
    legend.position = "right",  # Move legend to the right for better readability
    strip.text = element_text(size = 12)  # Increase facet label size
  ) +
  facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm"))+factor(season, levels = c("Winter", "Spring", "Summer")), scales = 'free_x' )

# top 10 phylum describes ~100% bac community
# top 10 class describes ~100% bac community
# top 15 order describes ~75-90% bac community with lowest in ENV1
# top 30 family describes ~75-90% bac community with lowest in ENV1

# change names of x-axis so it shows only days
#ggsave("tpm-proportion-across-samples.jpeg", p2)

p2
```

### Conclusion from NMDS analysis

::: callout-note
#### Key Takeaways:

1.  **Spatial and Seasonal Variation:**
    -   There is spatial separation between genomes across sites and seasons.
    -   Stronger seasonal differences are observed, especially between Coast Summer and Offshore Winter.
2.  **Low Dissimilarity Despite Stress:**
    -   Despite an stress of 0.101, dissimilarity between samples remains low, suggesting similarities in community composition across sites and seasons.
3.  **Venn Diagram Analysis:**
    -   Venn diagram analysis failed to identify unique genomes between samples (@fig-presence-unique-genomes), indicating limited differences in the genomic diversity across samples.
4.  **Summer vs Winter Dissimilarity:**
    -   @fig-nmds-only-rhodo shows a major difference in community composition between winter and summer, with summer showing stronger divergence.
    -   Sites cluster closely within each season, with outliers in the summer mesocosm.
5.  **Community Succession Indicated by MDS1:**
    -   The direction from left to right in MDS1 suggests a shift in community composition, indicating that changes in "what" the community expresses over time (rather than "who" is present) might be occurring, as reflected by the previous NMDS ( @fig-nmds ).
:::

## Plot taxonomy and rhodopsin transcript distribution

```{r fig-rhodopsin-family-level}
#| label: fig-rhodopsin-family-level
#| fig-cap: '**Abundance and Distribution of Rhodopsin-Containing Genomes Across Seasons and Environments.** Relative abundance (TPM) of the top 12 rhodopsin-containing genome families across different samples, seasons, and environments. Each bar represents a sample, with colors indicating different families. (A) shows the family-level relative abundance of rhodopsin genes within each sample, while (B) displays the overall relative abundance of the top 12 genome-containing rhodopsins families (GCR). The data highlights seasonal and spatial variations in rhodopsin gene expression across environments.'
#| fig-height: 10
#| fig-width: 10
#| warning: false
# Rhodopsin genes expression throughout seasons and mesocosms. by family
# Start creating a function for plotting the data
family_plot <- function(data, title, legend_position = "none", position = "stack") {
  data %>%
    ggplot(aes(x = sample, y = sum_tpm, fill = family)) +
    geom_col(colour = 'black', size = 0.1, position = position) +  # Stacked bars with black borders
    scale_fill_brewer(palette = 'Paired') +
    labs(
      title = title,
      x = "Sample",
      y = NULL,
      fill = "family"
    ) +
    theme_minimal() +  # Clean, modern theme
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Centered title
      axis.text.x = element_text(angle = 45, hjust = 1, size = 5),  # Rotate x-axis labels
      legend.position = legend_position,  # Position the legend
      strip.text = element_text(size = 12)  # Increase facet label size
    ) +
    facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm"))+factor(season, levels = c("Winter", "Spring", "Summer")), scales = 'free')
}

# Find the top 12 family
top.12.family.rhodo <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  #filter(pfams == 'Bac_rhodopsin') %>%
  group_by(family) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  filter( family != 'NA') %>%
  slice_max(sum_tpm, n = 12)

# RelAb Rhodopsin (tpm)
p4 <- counts.rhodo.genomes %>%
  inner_join(top.12.family.rhodo, join_by(family)) %>%
  filter(preferred_name == 'prd') %>%
  #filter(pfams == 'Bac_rhodopsin') %>%
  group_by(sample, family, season, site) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  family_plot(title = "RelAb Rhodopsin (tpm)", legend_position = "none") +
  theme(
      plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),  # Centered title
      axis.text.x = element_text(angle = 45, hjust = 1, size = 6),  # Rotate x-axis labels
      axis.text.y = element_text(hjust = 1, size = 6),  # Rotate x-axis labels
      strip.text = element_text(size = 7), # Increase facet label size
    ) 

# RelAb of top 12 gcr
p5 <- counts.rhodo.genomes %>%
  inner_join(top.12.family.rhodo, join_by(family)) %>%
  group_by(sample, family, season, site) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  family_plot(title = "RelAb of top gcr", legend_position = "right") +
  theme(
      plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),  # Centered title
      axis.text.x = element_text(angle = 45, hjust = 1, size = 6),  # Rotate x-axis labels
      axis.text.y = element_text(hjust = 1, size = 6),  # Rotate x-axis labels
      strip.text = element_text(size = 7), # Increase facet label size
      legend.key.size = unit(3, "mm"),  # Reduce legend key size
      legend.text = element_text(size = 6),  # Reduce legend text size
      legend.title = element_text(size = 7)  # Reduce legend title size
  )

p4 + p5 + plot_layout(guides = "collect") + plot_annotation(tag_levels = 'A', title = "Relative Abundance of Rhodopsin Across the Top 12 Families", subtitle = "(A) Relative abundance (TPM) of rhodopsin (prd) genes in the top 12 families across different seasons and sites.
                                                            (B) Relative abundance of the top 12 families based on genome counts (GCR) across seasons and sites.")
```

Transcript of rhodopsin from Pelagibacteriacea dominate the samples (@fig-rhodopsin-family-level A). This is particularly true for winter season and Offshore samples while Coast and Mesocosm shows variation during spring and summer. D2472 and Thioglobaceae are relevant in summer Mesocosm while both Spring and Summer in the coast, Poseidoniaceae and Puniceispirillaceae are inscreasing over time. Interesting enough, rhodopsin transcripts don't match with the relative abundance (@fig-rhodopsin-family-level B). Offshore winter is dominated by Alteromonadaceae and their presence seem relevant both in Coast-Winter, Coast-Summer and Mesocosm-Summer. Pelagibacteriaceae still accounts for the major taxa in Offshore-Summer Offshore-Spring, Mesocosm-Winter and Mesocosm-Spring. Mixed community is present in Coast-Spring, which shows relatively large group for Thioglobaceae and Poseidoniaceae.

It is important to mention that the taxa in @fig-rhodopsin-family-level A-B shares the most number of transcrpts: 87% of all rhodopsin transcripts in the dataset despite they are only \~19% of total taxa expressing rhodopsin. By looking at the total RelAb (@fig-total-proportion-gcr) those 19% of taxa represent 25-75% of the total, being relevant mainly in Summer-Mesocosm where they reach up to \~75% in the sample ENV3_D5_M and overall in Coast-Summer ( @fig-rhodopsin-family-distribution).

By performing a shannon-index analysis (@fig-shannon-index) most samples shows high level of mixed community (average index \> 3) with differences when the samples are grouped based on site and season (@fig-shannon-index B) with a big range of shift in the community for Coast samples especially in summer.

::: callout-note
### Key Takeaways:

1.  **Dominance of Pelagibacteriaceae:**
    -   Pelagibacteriaceae rhodopsin transcripts dominate the samples, particularly in Offshore Winter, with notable variation in Coast and Mesocosm samples during Spring and Summer (@fig-rhodopsin-family-level A).
2.  **Seasonal and Site Variation:**
    -   D2472 and Thioglobaceae are prominent in Summer Mesocosm, while Poseidoniaceae and Puniceispirillaceae increase over time in Coast and Mesocosm during Spring and Summer.
3.  **Mismatch Between Rhodopsin Transcripts and Abundance:**
    -   Rhodopsin transcript abundance does not correlate with the relative abundance of taxa (@fig-rhodopsin-family-level B).
    -   Offshore Winter is dominated by Alteromonadaceae, which is also relevant in Coast Winter, Coast Summer, and Mesocosm Summer.
    -   Pelagibacteriaceae remains dominant in Offshore Summer, Offshore Spring, Mesocosm Winter, and Mesocosm Spring.
    -   A mixed community is observed in Coast Spring, with notable abundance of Thioglobaceae and Poseidoniaceae.
4.  **Taxa Representation and Rhodopsin Transcripts:**
    -   The taxa represented in @fig-rhodopsin-family-level A-B account for 87% of all rhodopsin transcripts in the dataset, despite making up only about 19% of total taxa expressing rhodopsin.
    -   These 19% of taxa represent 25-75% of the total relative abundance (@fig-total-proportion-gcr), especially relevant in Summer Mesocosm, where they account for up to 75% of the sample ENV3_D5_M, and in Coast Summer (@fig-rhodopsin-family-distribution).
5.  **Shannon index shows high level of complexity at community level:**
    -   Suggested in the taxonomy plot and then as shown in @fig-shannon-index B there is a substantial fluctuation of community composition across site and seasons, with a general trend of lower complexity from winter to summer for all seasons.
:::

## Heatmap comparison for 50 most abundant genomes containing rhodopsin and rhodopsin variation within the genomes.

To compute the heatmap I decided to find the overall 50 most abundant genomes in the subset for genomes containing rhodopsin ( I kept the normalization as it was for the whole dataset). But since from @fig-total-proportion-gcr it looks like only a portion of family groups shows high abundance in rhodopsin, I decided to first filter for only those top12family. By cross-checking the dataset, I found out that with this method I didn't lose Woeseiaceae family which is the 6th in the top 12 family groups. Anyway, the same family, although is present in the subset, still has low total abundance therefore is discarded by this analysis. I might dive into Woeseiaceae in a second time. From the heatmap in @fig-top50genomes-heatmap, it looks like abundance of rhodopsin transcripts doesn't follow relative abundance of most genomes. In general, find a general pattern is hard. Relative abundance of genomes heatmap was generated by subset of the total transcript while for rhodopsin, the relative abundance was calculated within the genome.

::: callout-note
### Key Takeaways:

1.  **Selection of Top 50 Abundant Genomes:**
    -   To compute the heatmap, the 50 most abundant genomes in the subset containing rhodopsin were selected. The normalization was kept consistent with the whole dataset.
    -   The analysis was filtered for the top 12 family groups, as shown in @fig-total-proportion-gcr, where only a portion of family groups exhibit high abundance in rhodopsin.
2.  **Exclusion of Woeseiaceae:**
    -   Although Woeseiaceae (ranked 6th in the top 12 family groups) was retained in the subset, it was discarded from the analysis due to its low total abundance in the dataset.
    -   Further exploration of Woeseiaceae might be conducted separately.
3.  **Mismatch Between Rhodopsin Transcripts and Genome Abundance:**
    -   The heatmap in @fig-top50genomes-heatmap reveals that the abundance of rhodopsin transcripts does not correlate with the relative abundance of most genomes.
    -   Finding a general pattern is challenging, as rhodopsin relative abundance was calculated within the genome, while the genome heatmap represents the relative abundance of transcripts across the subset.
:::

```{r fig-top50genomes-heatmap }
#| label: fig-top50genomes-heatmap
#| fig-cap: '**Heatmap ranked by abundance. A)** Heatmap showing the top 50 genomes from the top 11 families, visualized by their total TPM (Transcripts Per Million) in each sample, highlighting the relative abundance of each genome across sites and seasons. **B)** Heatmap displaying the abundance of rhodopsin transcripts across the same top 50 genomes, emphasizing the expression of rhodopsin across sites and seasons.'
#| fig-height: 10
#| fig-width: 16

# First I wanted to check if I was losing important family when subsetting
# 
# tmp <- counts.rhodo.genomes %>%
#   inner_join(top50genomes, join_by(genome)) %>%
#   distinct(family) 
#
# top.12.family.rhodo %>%
#   anti_join(tmp, join_by(family))
#
# I was going to lose the family Woeseiaceae group which is the 6th
# Pull out family group to work with
top12 <- top.12.family.rhodo %>% select(family) %>% pull()

# Heatmap top50genomes containing rhodopsin
top50genomes <- counts.rhodo.genomes %>%
  filter( family %in% top12 ) %>%
  group_by(genome) %>%
  summarise(sum_tpm = sum(tpm)) %>%
  filter( genome != 'NA') %>%
  filter( genome != 'GCF_002407085.1') %>%
  filter( genome != 'GCF_003173795.1') %>%
  slice_max(sum_tpm, n = 50)

# Even though the group Woeseiaceae is in the top12, when I take the first 50 genomes, 
# this family is cutoff. It's good to remember in case I want to dig in separately since is the 6th in terms of
# rhodopsin expression.
# From the analysis I also removed GCF_002407085.1 and GCF_003173795.1 both alteromonadacea because
# then don't express rhodopsin.

# Step 1: Precompute factor levels from p8 data
genome_levels <- counts.rhodo.genomes %>%
  inner_join(top50genomes, join_by(genome)) %>%
  group_by(sample, genome, family, site, season, day) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate(
    family = as.factor(family),
    genome_with_family = paste0(genome, " (", family, ")")
  ) %>%
  group_by(genome_with_family) %>%
  summarise(total_tpm = sum(sum_tpm)) %>%
  arrange(desc(total_tpm)) %>%
  pull(genome_with_family)

# Step 2: p8 plot with fixed genome levels
p8 <- counts.rhodo.genomes %>%
  inner_join(top50genomes, join_by(genome)) %>%
  group_by(sample, genome, family, site, season, day) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate(
    family = as.factor(family),
    genome_with_family = paste0(genome, " (", family, ")"),
    genome_with_family = factor(genome_with_family, levels = genome_levels) # Use fixed levels
  ) %>%
  ggplot(aes(x = genome_with_family, y = sample, fill = sum_tpm)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "blue", high = "red", limits = c(0, 10000)) +  # Adjust limits to emphasize differences in a specific range
  labs(
    title = "Genomes",
    x = NULL,
    y = "Sample"
  ) +
  coord_flip() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    axis.text.y = element_text(size = 8),
    #legend.position = 'none',
    strip.text.x = element_text(size = 9)
  ) +
  facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm")) +
           factor(season, levels = c("Winter", "Spring", "Summer")),
           scales = 'free_x',
           ncol = 9)


# Recalculate tpm base on genomes and samples
individual.abundance <- counts.rhodo.genomes %>%
  select(-tpm) %>%
  group_by(sample, genome) %>%
  mutate(r = count/length) %>%
  mutate(tpm = r/sum(r) * 1e6) %>%
  ungroup() %>%
  select(-r) %>%
  as_tibble()

# remake 
p9 <- individual.abundance %>%
  inner_join(top50genomes, join_by(genome)) %>%
  filter(preferred_name == 'prd') %>%
  #filter( pfams == 'Bac_rhodopsin') %>%
  group_by(sample, genome, family, site, season, day) %>% 
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate(
    family = as.factor(family),
    genome_with_family = paste0(genome, " (", family, ")"), # Combine genome and family info
    #genome_with_family = fct_reorder(genome_with_family, as.numeric(family))
    genome_with_family = factor(genome_with_family, levels = genome_levels) # Apply fixed levels
  ) %>% 
  ggplot(aes(x = genome_with_family, y = sample, fill = sum_tpm)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "blue", high = "red", , limits = c(0, 100000)) +
  labs(
    title = "Rhodopsin - Recalc",
    x = NULL,
    y = "Sample"
  ) +
  coord_flip() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    axis.text.y = element_blank(),
    #legend.position = 'none',
    strip.text.x = element_text(size = 9)
  ) +
  facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm")) +
                factor(season, levels = c("Winter", "Spring", "Summer")),
              scales = 'free_x',
              ncol = 9)

#ggsave('heatmap-genomes-recalc-rhodopsin.jpeg', p8+p10)

# Print heatmap
p8+p9 + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A', title = "Heatmap of Top 50 Genomes and Rhodopsin Expression Across Samples", subtitle = "A. Genomic Abundance of the Top 50 Genomes from the Top 11 Families; B. Rhodopsin Transcript Expression in the Top 50 Genomes Across Sites and Seasons")
```

### Summary

-   **D2472 group:** Variations mainly in Offshore and Mesocosm, with rhodopsin more abundant in Coast; one genome follows a unique pattern.\
-   **Flavobacteriaceae:** Higher abundance in summer (Coast, Mesocosm); some winter exceptions; fluctuating rhodopsin levels.\
-   **Pelagibacteriaceae:** Seasonal changes in genome and rhodopsin abundance; Mesocosm shows a decline from winter to summer.\
-   **Thalassarchaeaceae:** High abundance in winter across all sites; transcript levels mirror genome abundance trends.\
-   **Alteromonadaceae:** No clear rhodopsin pattern, genome discarded.\
-   **HTCC2089 group:** Offshore peaks in spring/summer, Coast/Mesocosm in winter/spring; rhodopsin stable except for one genome.\
-   **Methylophilaceae:** Similar to HTCC2089, varying mainly in Coast/Mesocosm (Winter/Spring); rhodopsin remains stable.\
-   **Poseidoniaceae:** Genome and rhodopsin abundance peak in Coast-Spring/Summer, weak in Offshore.\
-   **Thalassobaculaceae:** Peaks in Offshore-Spring/Summer, Mesocosm-Winter/Spring; stable rhodopsin levels.\
-   **Thioglobaceae:** Spring/Summer peaks for two genomes, stable rhodopsin levels.\
-   **Puniceispirillaceae:** Mostly constant genome abundance, but high rhodopsin in two genomes, especially in Coast.

To see the heatmaps grouped by family, go to the [Splitting the heatmaps by family level](###_Splitting_the_heatmaps%20by_family_level) section.

## Correlation analysis with rhodopsin and environmental variables.

Since I couldn't find a good substitute for **DOC** ( see @fig-model-on-pca-scores ), I decided to continue (for now) by using **all environmental variables** and correlating them with **prd** to see if there is any correlation. I will keep an eye on those variables that were potentially correlated with DOC in the previous analysis (e.g., **DON, Chla_less_3um, and PO4**).

**N.B.:** For now, the correlation is with **ALL rhodopsin genes**. It is possible that patterns are hidden within specific groups (like **Flavos** and **Pelagibacter**).

### Spearman correlation analysis: rhodospin and environmental variables

@fig-spearman-prd-env shows the output from correlation analysis.

**Negative correlations (\<= -0.3):**

-   DOC (-0.31)

**Positive correlations (\>= 0.3):**

-   DON (0.45)

::: callout-note
#### **Key Takeaways:**

-   **DON** shows the strongest correlation with **prd**.\
-   **DOC** shows the second strongest correlation.\
-   Both results are **not significant** (data not showed) for **prd**.\
:::

```{r fig-spearman-prd-env }
#| label: fig-spearman-prd-env
#| fig.cap: "**Spearman correlation All environmental variables and rhodopsin:** Spearman correlation matrix between environmental variables and the abundance of rhodopsin genes across different samples. The correlation coefficients are shown in the plot, with no significant associations found between rhodopsin and environmental variables. Statistical significance was tested using pairwise correlation tests, but all correlations were non-significant (p-value > 0.05). In conclusion, no conclusive relationships were detected for rhodopsin in this analysis."
#| fig-height: 9
#| fig-width: 9
#| warning: false
#| echo: false

# I will follow the same approach as before but this time I wll add prd
# 1. Preapare the dataset by adding prd and removing S6 since I don't have DOC
prd.metadata <- counts.rhodo.genomes %>%
  dplyr::select(sample, preferred_name, tpm) %>%
  filter(preferred_name == 'prd') %>%
  group_by(sample, preferred_name ) %>%
  summarise( prd = sum(tpm), .groups = 'drop') %>%
  dplyr::select(-preferred_name) %>%
  right_join(metadata, join_by(sample)) %>%
  filter(!is.na(prd)) %>%
  filter(!str_detect(sample, "_S6$")) %>%
  dplyr::select(-day)

# Step 1
# Select only numeric columns
numeric_vars <- prd.metadata %>%
  dplyr::select(where(is.numeric))

# Ensure that all columns are numeric
numeric_vars <- as.data.frame(lapply(numeric_vars, as.numeric))

# Compute correlation matrix
cor_matrix <- cor(numeric_vars, use = "pairwise.complete.obs")

# Initialize an empty matrix for p-values
p_value_matrix <- matrix(NA, nrow = ncol(numeric_vars), ncol = ncol(numeric_vars))
rownames(p_value_matrix) <- colnames(numeric_vars)
colnames(p_value_matrix) <- colnames(numeric_vars)

# Loop through the pairs of variables to compute p-values
for(i in 1:(ncol(numeric_vars)-1)) {
  for(j in (i+1):ncol(numeric_vars)) {
    test_result <- cor.test(as.numeric(numeric_vars[,i]), as.numeric(numeric_vars[,j]))  # Ensure numeric input
    p_value_matrix[i,j] <- test_result$p.value
    p_value_matrix[j,i] <- test_result$p.value
  }
}

# I will not print the plot with p-value but I just need to report that the output is NO significance with PRD
# Visualize correlation matrix with p-values on the plot
ggcorrplot(cor_matrix, 
           type = "lower", 
           lab = TRUE) +        # Set significance threshold (p < 0.05)
  labs(title = "Spearman Correlation Between Environmental Variables and Rhodopsin-Related PRD",
       subtitle = "No Significant Correlation Found Between PRD and Environmental Variables")
```

```{r fig-spearman-prd-env-sign-level }
#| label: fig-spearman-prd-env-sign-level
#| fig.cap: "**Spearman correlation All environmental variables and rhodopsin:** Spearman correlation matrix between environmental variables and the abundance of rhodopsin genes across different samples. The correlation coefficients are shown in the plot, with no significant associations found between rhodopsin and environmental variables. Statistical significance was tested using pairwise correlation tests, but all correlations were non-significant (p-value > 0.05). In conclusion, no conclusive relationships were detected for rhodopsin in this analysis."
#| fig-height: 9
#| fig-width: 9
#| warning: false
#| echo: false

# I will follow the same approach as before but this time I wll add prd
# 1. Preapare the dataset by adding prd and removing S6 since I don't have DOC
prd.metadata <- counts.rhodo.genomes %>%
  dplyr::select(sample, preferred_name, tpm) %>%
  filter(preferred_name == 'prd') %>%
  dplyr::select(sample, tpm) %>%
  group_by(sample) %>%
  summarise( prd = sum(tpm), .groups = 'drop') %>%
  right_join(metadata, join_by(sample)) %>%
  filter(!is.na(prd)) %>%
  filter(!str_detect(sample, "_S6$")) %>%
  filter(!str_detect(sample, "_S3$")) %>%
  dplyr::select(-day, -tn, -tin, -don)

# Step 1
# Select only numeric columns
numeric_vars <- prd.metadata %>%
  dplyr::select(where(is.numeric))

# Ensure that all columns are numeric
numeric_vars <- as.data.frame(lapply(numeric_vars, as.numeric))

# Compute Spearman correlation matrix
cor_matrix <- cor(numeric_vars, method = "spearman", use = "pairwise.complete.obs")

# Compute p-value matrix
p_value_matrix <- matrix(NA, nrow = ncol(numeric_vars), ncol = ncol(numeric_vars))
rownames(p_value_matrix) <- colnames(numeric_vars)
colnames(p_value_matrix) <- colnames(numeric_vars)

for(i in 1:(ncol(numeric_vars)-1)) {
  for(j in (i+1):ncol(numeric_vars)) {
    test_result <- cor.test(numeric_vars[,i], numeric_vars[,j], method = "spearman")
    p_value_matrix[i, j] <- test_result$p.value
    p_value_matrix[j, i] <- test_result$p.value
  }
}

# Convert matrices to data frames for ggplot2
cor_df <- melt(cor_matrix)
colnames(cor_df) <- c("Var1", "Var2", "Correlation")

p_df <- melt(p_value_matrix)
colnames(p_df) <- c("Var1", "Var2", "p_value")

# Merge correlation and significance data
plot_data <- merge(cor_df, p_df, by = c("Var1", "Var2"))

# Define significance markers
plot_data$Significance <- ifelse(plot_data$p_value < 0.001, "***", 
                          ifelse(plot_data$p_value < 0.01, "**", 
                                 ifelse(plot_data$p_value < 0.05, "*", "")))

# Create heatmap with correlation values and significance markers
ggplot(plot_data, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile(color = "white") +  # Create heatmap tiles
  geom_text(aes(label = paste0(round(Correlation, 2), Significance)), size = 4) +  # Add correlation values & significance
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +  # Color scale
  theme_minimal() +
  labs(title = "Spearman Correlation Heatmap with Significance",
       fill = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### PCA: prd vs environmental variables

The **PCA plot** ( @fig-pca-prd-env ) shows that **DOC**, **DON**, and **Chla_less_3um** are somehow related and opposite to **prd**. This result is also consistent with the previous PCA when using only **environmental variables** @fig-pca-biplot.

```{r fig-pca-prd-env }
#| label: fig-pca-prd-env
#| fig.cap: "**PCA plot All environmental variables vs prd:** Principal Component Analysis (PCA) biplot examining the relationship between environmental variables and the abundance of rhodopsin across samples. The analysis is performed on numeric variables derived from environmental data and rhodopsin abundance, with missing values imputed using the mean substitution method. The PCA plot shows the distribution of the variables along the first two principal components, highlighting the variance in environmental factors and PRD abundance. The PCA was conducted after imputing missing data with a more robust imputation approach (imputePCA()), improving the reliability of the results. The plot suggests how the environmental variables and rhodopsin correlate in the multivariate space. In particular, DOC, DON and Chla_less_3um seem to be related to rhodopsin."
#| fig-height: 7
#| fig-width: 8
#| warning: false
#| echo: false
# Run PCA on numeric data
pca_result <- PCA(numeric_vars, scale.unit = TRUE, graph = FALSE)

# Plot PCA biplot
# fviz_pca_biplot(pca_result, repel = TRUE)

# PCA Warnings & Interpretation
# 
# I got this warning:
# 
# "Missing values are imputed by the mean of the variable."
# What Happened?
# PCA requires a complete dataset, so R automatically replaced missing values with the mean.
# This can weaken patterns, making results less reliable.
# The warning suggests using imputePCA() from the missMDA package, which uses a better method.
numeric_vars_imputed <- imputePCA(numeric_vars)$completeObs

pca_result <- PCA(numeric_vars_imputed, scale.unit = TRUE, graph = FALSE)
pca <- fviz_pca_biplot(pca_result, repel = TRUE) +
  labs(
    title = "PCA Plot of All Environmental Variables vs PRD",
    subtitle = "Principal Component Analysis on Environmental Variables and PRD Abundance"
  ) +
  theme(plot.title = element_text(face = "bold", size = 10))
pca
```

### Stepwise Linear Regression Model for prd Prediction

I built a regression model to predict **prd** (rhodopsin) from **environmental variables**. Through stepwise selection, I ended up with 6 significant predictors: **DOC**, **PO4**, **NO2**, **NH4**, **DON**, and **Chla_min_3um**.

``` r
lm(prd ~ + doc + po4 + no2 + nh4 + don + chla_min_3um, data = prd.metadata)
```

**Significant Predictors:**

-   **DOC** and **NO2** were significant predictors of prd (with p-values of 0.0287 and 0.0221, respectively).

**Model Performance:**

-   The model explained **96%** of the variability in prd (**R-squared = 0.9629**).
-   However, there were some large residuals, suggesting potential outliers or influential points that could be worth exploring further.

For the detailed results, see @fig-linear-model-prd-vs-env-parameters and the section stepwise-linear-model-explanation in Supplementary materials.

```{r fig-linear-model-prd-vs-env-parameters }
#| label: fig-linear-model-prd-vs-env-parameters
#| fig-cap: '**Stepwise linear model**: rhodopsin vs environmental parameters**. Results of a stepwise linear regression model evaluating the relationship between rhodopsin (prd) and selected environmental parameters (DOC, PO4, NO2, NH4, DON, and Chla_less_3um). The model was refined using the stepAIC() function to remove non-significant predictors based on AIC criteria. The stepwise model identifies the most influential environmental variables affecting rhodopsin abundance, addressing overfitting and collinearity issues.'
#| fig-height: 8
#| fig-width: 10
#| warning: false
#| echo: false

# Using linear model
model <- lm(prd ~ ., data = prd.metadata %>% dplyr::select(-season, -site))

# My regression output is full of NaNs and missing coefficients.
# This means the model is overfitting or has collinearity issues.
# 
# What Went Wrong?
# Degrees of Freedom Issue
# You have too many predictor variables for your number of observations.
# The model has 36 samples, but many variables (~20+), so R runs out of degrees of freedom.
# Perfect Multicollinearity
# Some variables are perfectly correlated (e.g., day and sample could be redundant).
# R automatically dropped some variables (NA in coefficients).
# Overfitting
# Your model fits too many variables, leading to a perfect R of 1, which is suspicious.

# Fix the Model
# 1. Remove Redundant Predictors
# 
# Drop highly correlated variables to prevent overfitting.
# 

model_reduced <- lm(prd ~ + doc + po4 + no2 + nh4 + don +
  chla_min_3um, data = prd.metadata)

#car::vif(model_reduced)

stepwise_model_reduced <- suppressWarnings(
  suppressMessages(
    MASS::stepAIC(model_reduced, direction = "both", trace = FALSE)
  )
)
summary_stepwise_model_reduced <- summary(stepwise_model_reduced)

stepwise_summary <- tidy(stepwise_model_reduced)
kable(stepwise_summary, digits = 3, caption = "**Summary of Stepwise Regression Model:**Results from a refined stepwise model focusing on key environmental parameters related to rhodopsin.")

```

### RDA analysis

#### Redundancy Analysis (RDA) of Microbial Community Composition and Environmental Variables

**Performing RDA Between Microbial Data and Environmental Parameters** **Workflow**

1.  Load data (microbial abundances & environmental parameters).
2.  Transform the microbial dataset (CLR or Hellinger transformation).
3.  Transform the environmental dataset (log + Z-score standardization).
4.  Perform RDA using vegan::rda().
5.  Visualize and interpret the results.

Redundancy analysis (RDA) is used to explore relationship between microbial community composition and environmental factors. The microbial data were transformed using the centered log-ratio (CLR) method to mitigate compositional bias, while environmental variables were log-transformed, standardized (Z-score), and filtered for collinearity to enhance interpretability.

The RDA model accounts for **46.4%** of the total variance in microbial composition (constrained variance = 266.6 out of 575 total inertia), with the **remaining 53.6%** attributed to unconstrained variation ( @fig-rda-summary-table ). The first two axes, RDA1 (25.4%) and RDA2 (9.1%), capture the most variation among constrained components.

Key environmental drivers include **nitrate (NO), phosphate (PO), chlorophyll-a (both total and \<3m fraction), and dissolved organic carbon (DOC)**.

The accumulated constrained eigenvalues reveal that RDA1 alone explains 54.8% of the constrained variance, while RDA1RDA3 together account for 87.1%, indicating that most of the explainable microbial variation is captured within the first few axes ( @fig-eigen-value ).

**Sample Distribution by Season** ( @fig-rda-analysis-genome-level )

-   **Winter** (Blue): Concentrated on the left side, linked to low DOC (?) and Chl-a but influenced by NO and NO.
-   **Spring** (Green): Distributed across the center and right side, meaning microbial communities in this season are linked to intermediate levels of DOC and Chl-a (unclear).
-   **Summer** (Pink): More spread toward the upper right quadrant, likely associated with higher DOC and Chl-a levels.

**Sample Distribution by Site** ( @fig-rda-analysis-genome-level )

-   **Offshore**, **Coast** and **Mesocosm** show separation.
-   **Offshore** samples are mostly found on the left, likely influenced by NO/NO.
-   **Coastal** samples are more centered, indicating a mix of environmental influences.
-   **Mesocosm** samples are more scattered but lean toward DOC and Chl-a influence.\

::: callout-note
**Key Takeaways**

-   **DOC** and **Chl-a** (total/min_3um) have a strong influence on microbial communities in Spring and Summer.
-   **NO** and **NO** are key drivers for samples on the left side, particularly in Winter and offshore environments.
-   **Seasonal** and **spatial** differences exist, with offshore and winter samples being distinct from mesocosm and summer samples.
:::

```{r fig-rda-analysis-genome-level }
#| label: fig-rda-analysis-genome-level
#| fig-cap: "**Redundancy Analysis (RDA) of Microbial Community Composition (sample) and Environmental Variables.** Relationship between microbial communities (samples) and environmental variables using a redundancy analysis (RDA). Microbial samples are represented by points on the plot, with different colors indicating seasons and shape sitess. Environmental variables are shown as red vectors, indicating their influence on microbial community composition. The lengths and directions of the vectors represent the strength and relationship of each environmental variable with the RDA axes. The biplot was constructed based on the microbial data transformed by centered log-ratio (CLR) and environmental data that were log-transformed and scaled (Z-score). Eigenvalues for the RDA axes indicate that the first axis explains 25.4% of the total variance, and the second axis explains 9.1%."
#| fig-height: 6
#| fig-width: 7
#| warning: false

# There are some variables that show collinearity so I can just discard some
# For the analysis I could:
# Keep no3 and remove nh4, sio2, tn, tin
# Keep po4 and remove ab, bb


# 1. Load your data (microbial abundances & environmental parameters).
rhodopsin.matrix <- counts.rhodo.genomes %>%
  #filter(preferred_name == 'prd') %>%
  select(sample, genome, tpm) %>%
  group_by(sample, genome) %>%
  summarise( sum_tpm = sum(tpm), .groups = 'drop') %>%
  pivot_wider(names_from = genome, values_from = sum_tpm) %>%
  #filter( !str_detect(sample, ".*_S6$" )) %>%
  #filter( !str_detect(sample, ".*_M$" )) %>%
  column_to_rownames("sample")

metadata.rda <- metadata %>% 
  filter(!sample %in% c("ENV1_D5_S3", "ENV2_D3_S3", "ENV3_D0_S3")) %>%
  #filter( !str_detect(sample, ".*_S6$" )) %>% 
  #filter( !str_detect(sample, ".*_M$" )) %>%
  column_to_rownames("sample") %>%
  select(-day, -site, -season, -nh4, -sio2, -tn, -tin, -ab, -bb, -don, -chla_less_3um )

# Align the samples rows
rhodopsin.matrix <- rhodopsin.matrix[rownames(metadata.rda), , drop = FALSE]

# Check that sample names match
# all(rownames(rhodopsin.matrix) == rownames(metadata.rda)) 

# 2. Transform the microbial dataset (CLR or Hellinger transformation).
microbial_data_clr <- clr(rhodopsin.matrix + 1)  # Add pseudocount to handle zeros

# 3. Transform environmental dataset
# Log transform environmental variables (adding 1 to avoid log(0))
env_data_log <- log(metadata.rda + 1)

# Z-score standardization
env_data_scaled <- scale(env_data_log)

# Sostituire NAs o rimuoverli
# Sostituzione
env_data_scaled[is.na(env_data_scaled)] <- apply(env_data_scaled, 2, mean, na.rm = TRUE)

# Rimozione
#env_data_scaled <- na.omit(env_data_scaled)

# 4. Perform RDA
# Run RDA
rda_model <- rda(microbial_data_clr ~ ., data = as.data.frame(env_data_scaled))

# Extract scores
scores <- as.data.frame(scores(rda_model, display = "sites"))
scores$sample <- rownames(scores) 

# join site and season
scores <- scores %>%
  inner_join(counts.rhodo.genomes %>% select(sample, site, season), join_by(sample))

# Environmental vectors
env_vectors <- as.data.frame(scores(rda_model, display = "bp"))
env_vectors$variable <- rownames(env_vectors)

ggplot(scores, aes(RDA1, RDA2)) +
  geom_point(aes(color = season, shape = site), size = 3) +  
  geom_segment(data = env_vectors, aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(length = unit(0.2, "cm")), color = "red") +
  geom_text_repel(data = env_vectors, aes(x = RDA1, y = RDA2, label = variable), 
                  size = 5, color = "red") +
  theme_minimal() +
  labs(title = "Redundancy Analysis (RDA) - Genome level",
       x = "RDA1",
       y = "RDA2") +
  scale_color_manual(values = c("Spring" = "green", "Summer" = "pink", "Winter" = "blue"))
```

#### Redundancy Analysis (RDA) of Rhodopsin Community Composition and Environmental Variables

Redundancy analysis (RDA) was used to explore relationship between rhodopsin community composition and environmental factors. The data **were filtered out from Offshore samples as they lack of DOC values**, transformed using the \*\*Hellinger transformation\*\* method to mitigate compositional bias. Environmental variables were log-transformed and standardized (Z-score). The `NAs` values were replaced with the median of respective columns and the final dataset was filtered for collinearity. Conducted RDA with command `rda(rhodopsin_data_hellinger ~ ., data = env_data_scaled)`. ANOVA (`anova(rhodopsin.rda_model, by = "axis", permutations = 999)`) was used to test the significance ( @fig-anova-rda-rhodopsin-table ) and it showed significant effects for the first three axes (RDA1, RDA2, and RDA3). Summary of RDA model scores for further interpretation can found @fig-summary-rda-rhodopsin.

The first three RDA axes explain a significant portion (**47.23%**) of the variance in the data with RDA1 explaining 23.63%, RDA2 13.92% and RDA3 9.68% of the variance. The remaining axes contribute minimally to explaining the variation. The residual variation (unexplained variance) is substantial so other factors not captured in the model could influence the data.

**Sample Distribution by Season** ( @fig-rda-analysis-rhodopsin-level )

-   **Winter** (Blue): samples show separation from other season, they cluster together. No clear correlation with any environmental variables.
-   **Spring** (Green): samples seem to be related to **nitrogen** coumponds and opposite relation (negative?) to **DOC** Samples also cluster together (apart from one sample from Mesocosm).
-   **Summer** (Pink): it is dispersed group it seems clear separation between **Coast** and **Mesocosm** samples. **DOC**, **Chla** and **PO4** create a strong response from the samples.

**Sample Distribution by Site** ( @fig-rda-analysis-rhodopsin-level )

-   **Coast** and **Mesocosm** do not always show separation.
-   **Coastal** samples are dispersed left to the right, indicating a mix of environmental influences. **Chla**, **PO4** seems to drive in **Summer** while in **Spring** both **nitrate** variables and **DOC** seem to have an effect.
-   **Mesocosm** samples are showing a main driving influence from **DOC** in **Summer** while during the other season the effect of environmental variable is unclear.\

::: callout-note
**Key Takeaways**

-   **DOC** and **Chl-a** (total/min_3um) have a strong influence on microbial communities in Summer. **DOC** affects samples in **Spring** as well.
-   **NO** and **NO** are drivers for samples on the upper side in **Spring** for .
-   **Seasonal** and **spatial** show major differences between sites in **Spring** and **Summer**.
:::

```{r fig-rda-analysis-rhodopsin-level }
#| label: fig-rda-analysis-rhodopsin-level
#| fig-cap: "**Redundancy Analysis (RDA) of Rhodopsin Community Composition (sample) and Environmental Variables.** The biplot was constructed based on the rhodopsin data transformed by Hellinger and environmental data that were log-transformed and scaled (Z-score). Eigenvalues for the RDA axes indicate that the first axis explains 23.6% of the total variance, and the second axis explains 13.9%"
#| fig-height: 6
#| fig-width: 7
#| warning: false

# There are some variables that show collinearity so I can just discard some
# For the analysis I will remove:
# Keep no3 and remove nh4, sio2, tn, tin
# Keep po4 and remove ab, bb

# 1. Load your data (rhodopsin abundances & environmental parameters).
rhodopsin.matrix <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  select(sample, genome, tpm) %>%
  group_by(sample, genome) %>%
  summarise( sum_tpm = sum(tpm), .groups = 'drop') %>%
  pivot_wider(names_from = genome, values_from = sum_tpm) %>%
  filter( !str_detect(sample, ".*_S6$" )) %>%
  #filter( !str_detect(sample, ".*_M$" )) %>%
  column_to_rownames("sample")

# replace NA with 0
rhodopsin.matrix[is.na(rhodopsin.matrix)] <- 0

metadata.rda <- metadata %>% 
  filter(!sample %in% c("ENV1_D5_S3", "ENV2_D3_S3", "ENV3_D0_S3")) %>%
  filter( !str_detect(sample, ".*_S6$" )) %>% 
  #filter( !str_detect(sample, ".*_M$" )) %>%
  column_to_rownames("sample") %>%
  select(-day, -site, -season, -nh4, -sio2, -tn, -tin, -ab, -bb, -don, -chla_less_3um )

# Align the samples rows
rhodopsin.matrix <- rhodopsin.matrix[rownames(metadata.rda), , drop = FALSE]

# Strict check
stopifnot(all(rownames(rhodopsin.matrix) == rownames(metadata.rda)))

# Check that sample names match
# all(rownames(rhodopsin.matrix) == rownames(metadata.rda)) 

# 2a. Transform the microbial dataset (CLR or Hellinger transformation).
#rhodopsin_data_clr <- clr(rhodopsin.matrix + 1)  # Add pseudocount to handle zeros

# 2b Tranform the rhodopsin with hellinger
rhodopsin_data_hellinger <- decostand(rhodopsin.matrix, method = "hellinger")

# 3. Transform environmental dataset
# Log transform environmental variables (adding 1 to avoid log(0))
env_data_log <- log(metadata.rda + 1)

# Z-score standardization
env_data_scaled <- scale(env_data_log)

# Ensure is a dataframe
env_data_scaled <- as.data.frame(env_data_scaled)

# Sostituire NAs o rimuoverli
# Sostituzione
env_data_scaled[is.na(env_data_scaled)] <- apply(env_data_scaled, 2, median, na.rm = TRUE)
#env_data_scaled[is.na(env_data_scaled)] <- apply(env_data_scaled, 2, mean, na.rm = TRUE)

# Rimozione
#env_data_scaled <- na.omit(env_data_scaled)

# 4. Perform RDA
# Run RDA
rhodopsin.rda_model <- rda(rhodopsin_data_hellinger ~ ., data = as.data.frame(env_data_scaled))

# Extract scores
rhodopsin.scores <- as.data.frame(scores(rhodopsin.rda_model, display = "sites"))
rhodopsin.scores$sample <- rownames(rhodopsin.scores) 

# join site and season
rhodopsin.scores <- rhodopsin.scores %>%
  inner_join(counts.rhodo.genomes %>% select(sample, site, season) %>% distinct(sample,.keep_all = TRUE), join_by(sample))

# Environmental vectors
rhodopsin.env_vectors <- as.data.frame(scores(rhodopsin.rda_model, display = "bp"))
rhodopsin.env_vectors$variable <- rownames(rhodopsin.env_vectors)

ggplot(rhodopsin.scores, aes(RDA1, RDA2)) +
  geom_point(aes(color = season, shape = site), size = 3) +  
  geom_segment(data = rhodopsin.env_vectors, aes(x = 0, y = 0, xend = RDA1, yend = RDA2), 
               arrow = arrow(length = unit(0.2, "cm")), color = "red") +
  geom_text_repel(data = rhodopsin.env_vectors, aes(x = RDA1, y = RDA2, label = variable), 
                  size = 5, color = "red") +
  theme_minimal() +
  labs(title = "Redundancy Analysis (RDA) - Rhodopsin level",
       x = "RDA1",
       y = "RDA2") +
  scale_color_manual(values = c("Spring" = "green", "Summer" = "pink", "Winter" = "blue"))
```

## Take home message from exploratory analysis.

1.  **Spatial and Seasonal Variation in Rhodopsin Genomes**

-   There is notable spatial separation between genomes across sites and seasons. Seasonal differences are particularly prominent between Coast Summer and Offshore Winter.
-   Despite the stress of 0.101, dissimilarity between samples remains low, indicating a similar community composition across sites and seasons.

2.  **Mismatch Between Rhodopsin Transcripts and Genomic Abundance**

-   Rhodopsin transcript abundance does **not always correlate** with the relative abundance of taxa, especially in some cases like **Offshore Winter**, which is dominated by Alteromonadaceae.
-   The taxa that express rhodopsin **account for 87% of all rhodopsin transcripts, yet they only represent \~19% of the taxa**. These taxa are particularly dominant in summer and mesocosm samples.

3.  **Community Succession Indicated by MDS1**

-   The MDS1 analysis shows a shift in community composition over time, suggesting changes in **what** the community expresses (e.g., rhodopsin) rather than **who** is present. This indicates that **the community may be undergoing succession, with different pattern across different taxa groups.**

4.  **Heatmap Analysis of Top 50 Rhodopsin-Containing Genomes**

-   The heatmap of the 50 most abundant genomes reveals that **rhodopsin transcript abundance does not consistently correlate with genome abundance**. It is difficult to identify a general pattern in the heatmap, as different family groups exhibit varying relationships between transcript and genome abundance.

5.  **Weak Correlations for between DOC and prd**

-   The correlation analysis revealed that **DON (0.45) and DOC (-0.31) showed notable correlations with prd, though neither was statistically significant**. PCA results also indicated that DOC, DON, and Chla_less_3um were inversely related to prd.
-   **A regression model identified DOC and NO2 as significant predictors of prd**, with an R-squared value of 96%. However, large residuals suggest the presence of potential **outliers**.

6.  **RDA shows association between prd and DOC**

-   **RDA** analysis at **genome** level and environmental variables showed an association with some samples and DOC, Chla and NO3 variables. Seasons separate well in biplot, especially between Winter and Summer.

-   **RDA** analysis on **rhodopsin genes** level and environmental variables showed a strong association with sMesocosm-Summer samples. A weak and opposite association is found instead for Coast-Spring samples. Winter season seem to affect the least the rhodopsin.

### Conclusion

::: callout-note
There is a **complex relationships between rhodopsin transcripts, community composition, and environmental variables**. While DON and DOC showed correlations with rhodopsin, neither was statistically significant. The PCA analysis suggests potential connections between DOC, DON, and Chla_less_3um with prd, but further exploration is needed. The stepwise regression model identified DOC and NO2 as significant predictors of prd, although large residuals suggest potential outliers or influential points. Overall, rhodopsin expression is influenced by multiple factors and different taxa might act differently based on rhodopsin's ecological role.
:::

## New actions

**Possible new actions to take based on results:**\
- New analysis with **only samples that actually have both rhodopsin and DOC.**\
- Subset the genomes or taxa groups based on their contribution to rhodopsin abundance as shown in @fig-cumulative-Contribution-to-Rhodopsin.\

## Supplementary figures

### NMDS Supplementary material

#### Ordination plots

```{r fig-ordination-plots }
#| fig-height: 10
#| warning: false
#| fig-cap: '**Ordination plots: A) Rhodopsin Expression, B) Genome Expression**. Non-metric multidimensional scaling (NMDS) ordination plots showing sample distributions based on rhodopsin and genome expression data. Points represent samples, with closer points indicating higher similarity in composition. The stress value indicates the goodness of fit of the ordination.'
# Start with rhodopsin NMDS
# Extract site scores (samples)
rhodo.scores <- as.data.frame(vegan::scores(rhodo.nmds, display = "sites")) %>%
  rownames_to_column("sample")

# Get stress value for annotation
stress_value <- round(rhodo.nmds$stress, 3)

# Ordination Plot with Stress, Hulls, and Labels
ordination.plot.nmds.rhodopsin <- ggplot(rhodo.scores, aes(NMDS1, NMDS2)) +
  geom_point(size = 3, alpha = 0.7, color = "blue") +  # Plot points
  geom_text_repel(aes(label = sample), size = 3) +  # Add sample labels
  geom_polygon(data = rhodo.scores, aes(group = 1), fill = NA, color = "gray", linetype = "dashed") +  # Convex hull
  annotate("text", x = min(rhodo.scores$NMDS1), y = min(rhodo.scores$NMDS2), 
           label = paste("Stress =", stress_value), hjust = 0, size = 5) +  # Stress annotation
  theme_minimal() +
  labs(title = "NMDS Ordination - Rhodopsin Expression",
       subtitle = "Points represent samples, closer points indicate similar community composition",
       x = "NMDS Axis 1",
       y = "NMDS Axis 2") +
  theme(plot.title = element_text(face = "bold"))


# Do the same for genomes
# Extract site scores (samples)
genomes.scores <- as.data.frame(vegan::scores(genome.nmds, display = "sites")) %>%
  rownames_to_column("sample")

# Get stress value for annotation
genome.stress_value <- round(genome.nmds$stress, 3)

# Ordination Plot with Stress, Hulls, and Labels
ordination.plot.nmds.genomes <- ggplot(genomes.scores, aes(NMDS1, NMDS2)) +
  geom_point(size = 3, alpha = 0.7, color = "blue") +  # Plot points
  geom_text_repel(aes(label = sample), size = 3) +  # Add sample labels
  geom_polygon(data = genomes.scores, aes(group = 1), fill = NA, color = "gray", linetype = "dashed") +  # Convex hull
  annotate("text", x = min(genomes.scores$NMDS1), y = min(genomes.scores$NMDS2), 
           label = paste("Stress =", genome.stress_value), hjust = 0, size = 5) +  # Stress annotation
  theme_minimal() +
  labs( title = "NMDS Ordination - Genomes Expression",
        subtitle = "Points represent samples, closer points indicate similar community composition",
        x = "NMDS Axis 1",
        y = "NMDS Axis 2") +
  theme(plot.title = element_text(face = "bold"))

ordination.plot.nmds.genomes / ordination.plot.nmds.rhodopsin
```

#### Shepard stress plot

##### Genome level

```{r fig-stressplot-genome}
#| label: fig-stressplot-genome
#| fig-cap: '**Shepard plots:** Genome dataset. Non-metric fit: R^2=0.984, Linear fit: R^2=0.941. Non-metric fit: R^2=0.99, Linear fit: R^2=0.954. Shepard plot showing the relationship between observed dissimilarities and ordination distances in the NMDS analysis. The closer the points are to the line, the better the NMDS fit, indicating how well the reduced-dimensional space represents the original data structure.'
#| warning: false
vegan::stressplot(rhodo.nmds, main = "B) Shepard Plot - Rhodopsin NMDS")
```

##### Rhodopsin level

```{r fig-stressplot-rhodopsin}
#| label: fig-stressplot-rhodopsin
#| fig-cap: '**Shepard plots:** Rhodopsin dataset. Non-metric fit: R^2=0.984, Linear fit: R^2=0.941. Non-metric fit: R^2=0.99, Linear fit: R^2=0.954. Shepard plot showing the relationship between observed dissimilarities and ordination distances in the NMDS analysis. The closer the points are to the line, the better the NMDS fit, indicating how well the reduced-dimensional space represents the original data structure.'
#| warning: false
vegan::stressplot(rhodo.nmds, main = "B) Shepard Plot - Rhodopsin NMDS")
```

#### Presence of unique genomes containing rhodopsin

```{r Check presence of unique genomes containing rhodopsin }
#| label: fig-presence-unique-genomes
#| fig-cap: '**Presence of unique genomes containing rhodopsin**'
#| fig-height: 4
#| warning: false

# there are genomes containig rhodopsin that are unique for season?
unique_by_season <- counts.rhodo.genomes %>%
  group_by(season, genome) %>%
  summarise(n_sites = n_distinct(site), .groups = "drop") %>%
  filter(n_sites == 1) 

# what about site?
unique_by_site <- counts.rhodo.genomes %>%
  group_by(site, genome) %>%
  summarise(n_seasons = n_distinct(season), .groups = "drop") %>%
  filter(n_seasons == 1)

# no unique genomes
unique_by_season_site <- counts.rhodo.genomes %>%
  group_by(season, site, genome) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(genome) %>%
  summarise(n_combinations = n(), .groups = "drop") %>%
  filter(n_combinations == 1)  # Appears in only one season-site combination


venn_data <- list(
  Season = unique(unique_by_season$genome),
  Site = unique(unique_by_site$genome),
  Season_Site = unique(unique_by_season_site$genome)
)

ggvenn(venn_data, fill_color = c("red", "blue", "green"))

# results NO unique genomes
```

### Taxonomy analysis Supplementary material

#### Total proportion of genome abundance of the genome containing rhodopsin

```{r fig-total-proportion-gcr}
#| label: fig-total-proportion-gcr
#| fig-cap: '**Proportion of Rhodopsin-Containing Genomes Across Samples and Seasons.** Total relative abundance of genomes containing rhodopsin (GCR) across different samples, seasons, and environments. Bars represent the proportion of transcript abundance attributed to each rhodopsin-containing genome family within each sample. White portions indicate the remaining taxa, which collectively account for 12% of the total rhodopsin transcript abundance. (Instead, here I am showing total genome abundance)'
#| warning: false
#| fig-height: 10
#| fig-width: 10

# Tot RelAb of gcr
p6 <- counts.rhodo.genomes %>%
  group_by(sample, family, season, site) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  family_plot(title = "Tot proportion of gcr", position = "fill")

p6

```

#### Shannon index

```{r fig-shannon-index}
#| label: fig-shannon-index
#| fig-cap: '**Shannon Diversity Index Across Samples and Sites/Seasons** **A)** Bar plot displaying the Shannon Diversity Index across individual samples, showing the variation in microbial diversity per sample. **B)** Boxplot depicting the Shannon Diversity Index grouped by site and season, illustrating the distribution of diversity within different environmental conditions.'
#| fig-width: 8
#| fig-height: 5
# Calculate the total TPM for each sample
total_tpm_per_sample <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  group_by(sample) %>%
  summarise(total_tpm = sum(tpm), .groups = 'drop')

# Calculate the relative abundance (proportion) for each family in each sample
diversity_data <- counts.rhodo.genomes %>%
  filter(preferred_name == 'prd') %>%
  inner_join(total_tpm_per_sample, by = "sample") %>%
  mutate(relative_abundance = tpm / total_tpm)

# Calculate Shannon Diversity Index
shannon_diversity <- diversity_data %>%
  group_by(sample) %>%
  summarise(
    shannon_index = -sum(relative_abundance * log(relative_abundance), na.rm = TRUE)
  )

# Add Shannon Index to diversity_data for plotting
diversity_data <- diversity_data %>%
  inner_join(shannon_diversity, by = "sample")

# Box plot for Shannon Index by site or season
shannon.box <- ggplot(diversity_data, aes(x = factor(site, levels = c("Offshore", "Coast", "Mesocosm")), y = shannon_index, fill = factor(season, levels = c("Winter", "Spring", "Summer")))) +
  geom_boxplot() +
  theme(plot.title = "Season")+
  theme_minimal() +
  labs(
    title = "Shannon Diversity Index by Site and Season",
    x = "Site",
    y = "Shannon Diversity Index",
    fill = "Season"
  )

shannon.box + plot_annotation(tag_levels = 'A', title = "Shannon index boxplotn based on sites and seasons.")
```

#### Rhodopsin family distribution

```{r fig-rhodopsin-family-distribution }
#| label: fig-rhodopsin-family-distribution
#| fig-cap: '**Summary of rhodopsin transcript abundance across families.** Total TPM of rhodopsin-containing genomes, the TPM contribution from the top 12 families, and the remaining TPM from other families. The percentage values reflect the dominance of the top 12 families, which account for 87% of the total rhodopsin transcript abundance, while only ~19% of the taxa contribute to the majority of the rhodopsin transcripts.'
#| fig-height: 3
#| warning: false
# This code is here to check the proportion in % of grc from top 12 genomes and the remaining ones.
#
# Create a dataset with sum of prd divided by family
# tmp <- counts.rhodo.genomes %>%
#   filter(preferred_name == 'prd') %>%
#   group_by(family) %>%
#   summarise(sum_tpm = sum(tpm), .groups = 'drop')

# Get the total tpm of prd
# tmp %>%
#   summarise(sum = sum(sum_tpm))
# 
# total=49821
#
# Find out the remaining TPM after removing tpm from the top12genomes
# tmp %>%
#   anti_join(top.12.family.rhodo %>% select(-sum_tpm), join_by(family)) %>%
#   summarise(sum = sum(sum_tpm))
# total_other_taxa=6189.799
# Now I got the
# per_top12genomes_with_prd <- 6154.217/(49634.02/100)
#
# The 87% of tpm for rhodospin is present in 12 taxa (family level) out of 64.
#
# per_taxa_top12genomes_with_prd <- 12/(64/100)
# So it's only ~19% of taxa that account for most of rhodopsin transcripts.
#
# I will make a table out of this last results.
total <- 49634.02
total_other_taxa <- 6189.799
per_top12genomes_with_prd <- 100 * (total_other_taxa / total)  # Percentage
per_taxa_top12genomes_with_prd <- 100 * (12 / 64)  # Percentage

# Calculate the average Shannon Diversity Index
average_shannon <- mean(shannon_diversity$shannon_index)

# Create a summary table
summary_table <- tibble(
  Metric = c(
    "Total TPM (Bac_rhodopsin)",
    "Total number of families",
    "TPM from top 12 families",
    "TPM from other families",
    "Percentage from top 12 families",
    "Percentage of families contributing most TPM",
    "Percentage from other families",
    "Average Shannon index"
  ),
  Value = c(
    total,
    64,
    43444.22,
    6189.79,
    87.5,
    per_taxa_top12genomes_with_prd,
    "13%",
    4.31
  )
)

kable(summary_table, digits = 2, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

### Splitting the heatmaps by family level

I decided to Split the heatmaps by family level makes it easier to describe the patterns observed.

#### D2472 Group (@fig-grouped-heatmaps-1 *A-B*)

-   Some genomes (**GCA_016777045.1, GCA_003283765.1, and GCA_000307935.1**) show notable variations in relative abundance, mainly in **Offshore and Mesocosm** environments.\
-   The most significant variations occur in **Offshore-Spring, Offshore-Summer, Mesocosm-Winter, and Mesocosm-Spring**.\
-   For some of these genomes, **rhodopsin relative abundance** is higher in the **Coast** across all seasons compared to Offshore and Mesocosm.\
-   **GCA_003284195.1** follows a unique pattern, with stable genome abundance but high rhodopsin transcript levels in **Coast-Winter and Coast-Spring**.

#### Flavobacteriaceae (@fig-grouped-heatmaps-1 *C-D*)

-   Genomes are generally **more abundant in summer**, particularly in **Coast and Mesocosm**, with some exceptions showing high abundance in **Mesocosm-Winter**.\
-   Rhodopsin abundance fluctuates inconsistently across samples, with notable peaks in **Offshore-Spring (metabat2.1668) and Mesocosm-Summer (GCA_0018674025.1)**.\
-   **GCF_024362345.1, GCF_002943715, and GCA_016777325.1** exhibit opposite abundance patterns in **Mesocosm-Summer**:
    -   **GCA_016777325.1** is higher in the first three days.\
    -   The other genomes increase in the last two days.\
    -   This genome pattern is mirrored by rhodopsin transcript abundance.

#### Pelagibacteriaceae (@fig-grouped-heatmaps-1 *E-F*)

-   In **Offshore samples**, genome relative abundance is **lower in winter and higher in spring and summer**.\
-   In **Coast samples**, only two genomes (**GCA_003279685.1 and GCA_902560015.1**) peak in **spring**.\
-   In **Mesocosm samples**, genome abundance generally **decreases from winter to summer**, except for **GCA_003279685.1**, which remains high throughout all seasons.\
-   Rhodopsin transcript abundance follows a similar trend, with **higher levels in winter and spring and lower in summer** (**GCA_003282895.1, GCA_902558745.1, and GCA_902560015.1**).\
-   This trend is consistent in **Offshore and Coast**, except for one genome that remains high in **Coast-Summer**.\
-   Rhodopsin transcript abundance is **consistently low in Mesocosm samples**.

#### Thalassarchaeaceae (@fig-grouped-heatmaps-1 *G-H*)

-   Genomes (**GCA_022451725.1, GCA_022426005.1, and GCA_016845715.1**) show **high abundance in winter** across all sites.\
-   One genome is particularly abundant in **Offshore-Spring**, but also shows high abundance in **Offshore-Summer and Coast-Summer**.\
-   **GCA_022426005.1** is also abundant in **Coast-Summer**.\
-   In this family, **relative abundance and transcript levels follow a similar trend**, with rhodopsin transcripts peaking in **winter**.

```{r fig-grouped-heatmaps-1}
#| label: fig-grouped-heatmaps-1
#| fig-cap: '**Group 1: Heatmap ranked by abundance.** **A-B** D2472, left genomes, right rhodopsin. **C-D** Flavobacteriaceae, left genomes, right rhodopsin. **E-F** Pelagibacteriaceae, left genomes, right rhodopsin. **G-H** Thalassarchaceae, left genomes, right rhodopsin.'
#| fig-height: 15
#| fig-width: 16

# The heatmap is really messy so I will try to plot it in a different way
# Pull the 12 top family
top_families <- top.12.family.rhodo %>%
  count(family, sort = TRUE) %>%
  top_n(3, n) %>%
  pull(family)

# group the top family
counts.rhodo.genomes <- counts.rhodo.genomes %>%
  mutate(family_group = ifelse(family %in% top_families, family, "Other"))

# Create an array of plots for at genome level
plots.genome.level <- counts.rhodo.genomes %>%
  inner_join(top50genomes, join_by(genome)) %>%
  group_by(sample, genome, family, site, season, family_group) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate(
    family = as.factor(family),
    genome_with_family = paste0(genome, " (", family, ")"),
    genome_with_family = factor(genome_with_family, levels = genome_levels) # Use fixed levels
  ) %>%
  group_split(family_group) %>%
  map(~ ggplot(.x, aes(x = genome, y = sample, fill = sum_tpm)) +
        geom_tile(color = "white") +
        scale_fill_gradient(low = "blue", high = "red", limits = c(0, 10000)) +
        labs(title = unique(.x$family_group), x = NULL, y = "Sample") +
        theme(
          axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
          #axis.text.y = element_blank(),
          strip.text.x = element_text(size = 9)
        ) +
        coord_flip() +
        facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm")) +
                factor(season, levels = c("Winter", "Spring", "Summer")),
              scales = 'free_x',
              ncol = 9))

# Create an array of plots at rhodopsin level
plots.rhodopsn.level <- individual.abundance %>%
  inner_join(top50genomes, join_by(genome)) %>%
  filter(preferred_name == 'prd') %>%
  #filter( pfams == 'Bac_rhodopsin') %>%
  mutate(family_group = ifelse(family %in% top_families, family, "Other")) %>%
  group_by(sample, genome, family, site, season, family_group) %>%
  summarise(sum_tpm = sum(tpm), .groups = 'drop') %>%
  mutate(
    family = as.factor(family),
    genome_with_family = paste0(genome, " (", family, ")"),
    genome_with_family = factor(genome_with_family, levels = genome_levels) # Use fixed levels
  ) %>%
  group_split(family_group) %>%
  map(~ ggplot(.x, aes(x = genome, y = sample, fill = sum_tpm)) +
        geom_tile(color = "white") +
        scale_fill_gradient(low = "blue", high = "red", limits = c(0, 100000)) +
        labs(title = unique(.x$family_group), x = NULL, y = "Sample") +
        theme(
          axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
          #axis.text.y = element_blank(),
          strip.text.x = element_text(size = 9)
        ) +
        coord_flip() +
        facet_wrap(~factor(site, levels = c("Offshore", "Coast", "Mesocosm")) +
                factor(season, levels = c("Winter", "Spring", "Summer")),
              scales = 'free_x',
              ncol = 9))

plots.genome.level[[2]] + plots.rhodopsn.level[[2]] + plots.genome.level[[3]] + plots.rhodopsn.level[[3]] +
plots.genome.level[[6]] + plots.rhodopsn.level[[6]] + plots.genome.level[[9]] + plots.rhodopsn.level[[9]] + plot_layout(ncol = 2, guides = "collect") + plot_annotation(tag_levels = 'A')
```

#### Alteromonadaceae (@fig-grouped-heatmaps-2 *A-B*)

-   The only genome lacks a clear pattern in rhodopsin abundance, appearing in only a few samples. **This genome is discarded.**

#### HTCC2089 Group (@fig-grouped-heatmaps-2 *C-D*)

-   **Genome abundance varies between Offshore, Coast, and Mesocosm:**
    -   **Offshore:** Higher in **spring and summer**.\
    -   **Coast and Mesocosm:** Higher in **winter and spring**.\
-   Rhodopsin abundance shows little variation, except for **GCA_024643905.1**, which peaks in **Offshore-Winter and Coast-Winter**.

#### Methylophilaceae (@fig-grouped-heatmaps-2 *E-F*)

-   **GCA_019823025.1** follows a similar pattern to the **HTCC2089** group, with most variation in **Coast and Mesocosm** during **Winter and Spring**, but low in **Summer and Offshore**.\
-   Rhodopsin abundance remains stable across all samples.

#### Poseidoniaceae (@fig-grouped-heatmaps-2 *G-H*)

-   Genome abundance shows strong variation in **Coast-Spring and Coast-Summer**, coinciding with higher rhodopsin levels.\
-   Rhodopsin is **poorly detected in Offshore** samples across all seasons.

```{r fig-grouped-heatmaps-2}
#| label: fig-grouped-heatmaps-2
#| fig-height: 10
#| fig-width: 16
#| fig-cap: '**Group 2: Heatmap ranked by abundance.** **A-B** Alteromonadaceae, left genomes, right rhodopsin. **C-D** HTCC2089, left genomes, right rhodopsin. **E-F** Methylophilaceae, left genomes, right rhodopsin. **G-H** Poseidoniaceae, left genomes, right rhodopsin.'

plots.genome.level[[1]] + plots.rhodopsn.level[[1]] + plots.genome.level[[4]] + plots.rhodopsn.level[[4]] +
plots.genome.level[[5]] + plots.rhodopsn.level[[5]] + plots.genome.level[[7]] + plots.rhodopsn.level[[7]] + plot_layout(ncol = 2, guides = "collect") + plot_annotation(tag_levels = 'A')
```

#### Thalassobaculaceae (@fig-grouped-heatmaps-3 *A-B*)

-   **Higher genome abundance in Offshore-Spring, Offshore-Summer, Mesocosm-Winter, and Mesocosm-Spring.**\
-   Rhodopsin levels remain **constant**, except for some missing detections in **Offshore-Summer, Mesocosm-Summer, and Spring-Coast**.

#### Thioglobaceae (@fig-grouped-heatmaps-3 *C-D*)

-   **Genome abundance peaks in Spring and Summer.**\
-   Two genomes (**GCA_902556695.1 and GCA_902556275.1**) exhibit a **similar abundance pattern**.\
-   Rhodopsin levels remain mostly constant, with minimal variation.

#### Puniceispirillaceae (@fig-grouped-heatmaps-3 *E-F*)

-   **Genome abundance remains stable across sites and seasons**, except for some variation in **Mesocosm-Winter and Mesocosm-Spring**.\
-   **Two genomes (**GCA_022425485.1 and GCA_003212345.1**) have high rhodopsin transcript levels, particularly in Coast samples.**

```{r fig-grouped-heatmaps-3}
#| label: fig-grouped-heatmaps-3
#| fig-height: 8
#| fig-width: 16
#| fig-cap: '**Group 3: Heatmap ranked by abundance.** **A-B** Thalassobaculaceae, left genomes, right rhodopsin. **C-D** Thioglobaceae, left genomes, right rhodopsin. **E-F** Puniceispirillaceae, left genomes, right rhodopsin.'

plots.genome.level[[10]] + plots.rhodopsn.level[[10]] + plots.genome.level[[11]] + plots.rhodopsn.level[[11]] +
plots.genome.level[[8]] + plots.rhodopsn.level[[8]] + plot_layout(ncol = 2, guides = "collect") + plot_annotation(tag_levels = 'A')
```

### Find a collinear environmental variable for DOC

DOC values are missing for some samples, particularly in Offshore samples (S6). To address this, I explored whether an alternative variable could be used instead of DOC in this study.

> **Note:** Removing S6 from the analysis did not significantly alter the observed patterns. Therefore, I will retain these samples in the analysis.

#### Spearman correlation DOC vs environmental variables

The correlation plot (@fig-corr-plot-environmental-variables) reveals no strong correlations between DOC and other environmental variables:

-   **DOC & Chla:** r = 0.37 (weak to moderate correlation)\
-   **DOC & DON:** r = 0.19 (weak correlation)

::: callout-note
##### Key Takeaways

-   Chlorophyll (Chla) is not strongly correlated to DOC.\
-   Dissolved organic nitrogen (DON) is an even weaker colinear variable\
-   Since correlation patterns remained unchanged after removing S6, the missing data is not significantly affecting the results.\
:::

```{r fig-corr-plot-environmental-variables }
#| label: fig-corr-plot-environmental-variables
#| fig-height: 8
#| fig-width: 16
#| warning: false
#| echo: false
#| fig-cap: '**Spearman correlation analysis environmental variables**'

# Create the matrix I will use for this analysis and the next ones.
numeric_vars <- metadata %>%
  mutate( day = as.character(day)) %>%
  select(where(is.numeric))

# Compute correlation matrix
cor_matrix <- cor(numeric_vars, use = "pairwise.complete.obs")

# Visualize correlation matrix
ggcorrplot(cor_matrix, type = "lower", lab = TRUE)

# Removing S6 doesn't change pattern that much
# 
# DOC & Chla: r = 0.37 (weak/moderate correlation)
# DOC & DON: r = 0.19 (weak correlation)
# Key Takeaways:
# Chlorophyll might be a weak colinear variable for DOC, but not a strong one.
# DON is an even weaker colinear variable
# Since correlation didn't change after removing S6, missing data isnt distorting results.

```

#### PCA environmental variables

::: callout-note
##### Key Takeaways

The PCA plot (@fig-pca-biplot) suggests that:

-   DOC and DON exhibit similar behavior.\
-   **Chla_less_3m** follows a similar but weaker pattern.\
-   Other environmental variables do not show a clear relationship with DOC.\
:::

```{r fig-pca-biplot }
#| label: fig-pca-biplot
#| fig-height: 8
#| fig-width: 16
#| warning: false
#| echo: false
#| fig-cap: '**PCA environmental variables**'

# Run PCA on numeric data
pca_result <- PCA(numeric_vars, scale.unit = TRUE, graph = FALSE)

# Plot PCA biplot
# fviz_pca_biplot(pca_result, repel = TRUE)

# PCA Warnings & Interpretation
# 
# I got this warning:
# 
# "Missing values are imputed by the mean of the variable."
# What Happened?
# PCA requires a complete dataset, so R automatically replaced missing values with the mean.
# This can weaken patterns, making results less reliable.
# The warning suggests using imputePCA() from the missMDA package, which uses a better method.
numeric_vars_imputed <- imputePCA(numeric_vars)$completeObs

# Recompute PCA analysis
pca_result <- PCA(numeric_vars_imputed, scale.unit = TRUE, graph = FALSE)

# Visualize pcs biplot
fviz_pca_biplot(pca_result, repel = TRUE)

# Results:
# pca shows that DOC and DON are somehow colinear, also chla_less_3m does the same but weaker

```

```{r fig-linear-model }
#| label: fig-linear-model
#| fig-cap: '**Reduced stepwise linear model**: Table output with summary of the environmental variables that seems to contribute more to DOC variation through the dataset.'
#| warning: false
#| echo: false
#| eval: false


##### Linear model for explaining DOC with environmental variables

#After removing confounding variables, I built a mixed linear model using a stepwise method to reduce complexity:
  
#lm(formula = doc ~ po4 + no3 + chla_min_3um + ab, data = metadata)

# For detailed results, see @fig-linear-model.
# 
# ::: callout-note
# ###### Key Takeaways
# 
# -   **po4, no3, chla_min_3um, and ab** are the most relevant predictors for DOC.\
# -   **no3 and ab** are significant predictors.\
# -   **po4 and chla_min_3um** are borderline significant (p  0.06).\
# -   The model explains **\~58% of the variance** in DOC.\
# -   The stepwise method reduced multicollinearity and removed non-contributing variables.
# :::

# Visualize correlation matrix
# Using linear model
model <- lm(doc ~ ., data = metadata %>% select(-season, -site))
# summary(model)

# My regression output is full of NaNs and missing coefficients.
# This means the model is overfitting or has collinearity issues.
# 
# What Went Wrong?
# Degrees of Freedom Issue
# You have too many predictor variables for your number of observations.
# The model has 36 samples, but many variables (~20+), so R runs out of degrees of freedom.
# Perfect Multicollinearity
# Some variables are perfectly correlated (e.g., day and sample could be redundant).
# R automatically dropped some variables (NA in coefficients).
# Overfitting
# Your model fits too many variables, leading to a perfect R of 1, which is suspicious.

# Fix the Model
# 1. Remove Redundant Predictors
# 
# Drop highly correlated variables to prevent overfitting.
# 

model_reduced <- lm(doc ~ + po4 + no3 + no2 + nh4 +
  chla_min_3um + ab, data = metadata)
# car::vif(model_reduced)

stepwise_model_reduced <- suppressWarnings(
  suppressMessages(
    MASS::stepAIC(model_reduced, direction = "both", trace = FALSE)
  )
)

stepwise_summary <- tidy(stepwise_model_reduced)
#kable(stepwise_summary, digits = 3, caption = "Summary of Stepwise Regression Model")
```

#### Linear model on PCA scores DOC vs other environmental variables

Although I could find significant predictors with stepwise method model (hidden in this report), the effect still seems too weak.\
So, I decided to use **PCA scores** to compute a linear model.\
This simplifies the model and avoids multicollinearity (@fig-model-on-pca-scores).

**1. Dim.1 (Explains the most variance)**

**Strong positive contributors:**\
- TIN (0.93), SiO2 (0.86), NO3 (0.85), TN (0.81), NO2 (0.73), NH4 (0.65)

**Strong negative contributors:**\
- BB (-0.57), DOC (-0.50), DON (-0.44), PO4 (-0.37), AB (-0.39)

**2. Dim.2 (Second to explain most variance)**

**Strong positive contributors:**\
- PO4 (0.76), Chla_min_3um (0.69), AB (0.69), BB (0.61)

**Strong negative contributors:**\
- DON (-0.75), DOC (-0.54), Chla_less_3um (-0.48)

::: callout-note
##### Key Takeaways

**Interpretation:**\
- Dim.1 is dominated by **inorganic nutrients** (TIN, NO3, NO2, NH4, TN).\
- Dim.2 represents **phosphate and particle-related properties** (Chla, BB, AB).\
- High DON and DOC are associated with **lower phosphate-related properties**. - DOC and DON are **negatively associated** with the main inorganic nutrients.
:::

```{r fig-model-on-pca-scores }
#| label: fig-model-on-pca-scores
#| fig-cap: '**linear model based on PCA scores**: Table output with summary of the coordindates that seems seems to contribute more to DOC variation through the dataset. Details of the output can be found in the text.'

# Visualize correlation matrix
# 2 Use Principal Components Instead of Raw Variables
# 
# Instead of many raw variables, use PCA results:

pca_scores <- data.frame(pca_result$ind$coord)  # Extract PCA scores
pca_scores$doc <- metadata$doc  # Add DOC as the response variable

model_pca <- lm(doc ~ ., data = pca_scores)  # Run regression with PCs

# This simplifies the model and avoids multicollinearity.

# pca_result$var$coord
# 
# Key Takeaways
# 1 Dim.1 (Explains the most variance)
# 
# Strong positive contributors:
# TIN (0.93), SiO2 (0.86), NO3 (0.85), TN (0.81), NO2 (0.73), NH4 (0.65)
#   Interpretation: Dim.1 is dominated by inorganic nutrients (TIN, NO3, NO2, NH4, TN).
# Strong negative contributors:
# BB (-0.57), DOC (-0.50), DON (-0.44), PO4 (-0.37), AB (-0.39)
#   Interpretation: DOC and DON are negatively associated with the main inorganic nutrients.
# 2 Dim.2 (Secondary variance)
# 
# Strong positive contributors:
# PO4 (0.76), Chla_min_3um (0.69), AB (0.69), BB (0.61)
#  Interpretation: Dim.2 represents phosphate and particle-related properties (Chla, BB, AB).
# Strong negative contributors:
# DON (-0.75), DOC (-0.54), Chla_less_3um (-0.48)
#   Interpretation: High DON and DOC are associated with lower phosphate-related properties.


# print summary
pca_summary <- tidy(model_pca)
kable(pca_summary, digits = 3, caption = "Summary of Regression Model on PCA scores")
```

#### **Final Interpretation**

From the reduced model analysis (**lm with selected variables**), it appears challenging to find a direct colinearity between **DOC** and other environmental variables.

-   **DON** seems promising, but it is not available for **mesocosm** samples.\
-   **NO3 and AB** are significant predictors, but **AB has little influence** on DOC.\
-   **NO3 appears to be the best predictor**, acting **opposite to DOC** (i.e., NO3 increases when DOC decreases and vice versa).

##### **Conclusion**

Since **DOC is negatively loaded on both Dim.1 and Dim.2**, this suggests that:\
- **Higher inorganic nutrients** (NO3, NO2, NH4, SiO2, TN) = **Lower DOC**\
- **Higher PO4, Chla_min_3um, and AB** = **Lower DOC**

Based on these results:

::: callout-note
-   I **can focus only on samples from the Coast and Mesocosm** when analyzing DOC.\
-   I **could use a combination of variables to explain DOC** but this approach can be risky since no major drivers where found\
:::

### Rhodopsin and environmental variables

#### Stepwise-linear-model-explanation

-   **Linear Model (stepAIC):** The code performs a **linear regression** of rhodopsin (prd) against several environmental parameters using the **lm()** function. Due to collinearity and overfitting issues, a reduced model is created, and stepAIC is used for stepwise selection, which iteratively removes predictors that do not significantly improve the model fit. This helps in identifying the most influential variables.

-   **NaNs and Missing Coefficients:** The initial model suffered from collinearity and overfitting due to the number of predictors relative to the small sample size (36 samples). The resulting coefficients were NaN or missing due to multicollinearity, where predictor variables are highly correlated, leading to redundancy and instability in the model. By selecting a reduced set of variables, the model addresses these issues and provides a clearer, more reliable output.

-   **VIF (Variance Inflation Factor):** The commented-out code car::vif() is typically used to check the multicollinearity of the predictors.

-   **Output:** The output of stepAIC is summarized using summary(stepwise_model_reduced) and tidy() from the broom package to format the model summary for easy presentation in a table, which is rendered using kable() and can be seen in @fig-linear-model-prd-vs-env-parameters.

#### RDA supplementary tables

##### RDA genomes level

```{r fig-anova-rda-genome-table }
#| label: fig-anova-rda-genome-table
#| fig-cap: '**ANOVA results for the redundancy analysis (RDA) at genome level:** Permutation test (999 permutations) was used to assess the significance of each constrained axis. Significant axes (p < 0.05) indicate that they explain a meaningful portion of the variation in the dataset.'
#| warning: false
#| echo: false
# Check if the model is significant
# Example ANOVA results (assuming `rhodopsin.rda_model` is your model)
genome.anova_results <- anova(rda_model, by = "axis", permutations = 999)

# Convert to a data frame for kable formatting
genome.anova_df <- as.data.frame(genome.anova_results)

# Use kable to format the table
kable(genome.anova_df, caption = "ANOVA Results for RDA Model (Permutation Test)", 
      col.names = c("Axis", "Df", "Variance", "F-Value", "Pr(>F)"), 
      digits = c(0, 0, 4, 4, 4))  # Adjust number of decimals as needed

```

```{r fig-rda-summary-table }
#| label: fig-rda-summary-table
#| fig-cap: '**Partitioning of variance in the redundancy analysis (RDA) model at genome level: ** The table is showing the total inertia (variance), the proportion explained by constrained (predictor-associated) components, and the residual (unconstrained) variance. Higher constrained variance indicates a stronger explanatory power of the selected environmental variables.'
#| warning: false
#| echo: false
# Extract variance partitioning
variance_partition <- data.frame(
  Component = c("Total", "Constrained", "Unconstrained"),
  Inertia = c(sum(rda_model$tot.chi), sum(rda_model$CCA$eig), sum(rda_model$CA$eig)),
  Proportion = c(1, sum(rda_model$CCA$eig) / sum(rda_model$tot.chi), sum(rda_model$CA$eig) / sum(rda_model$tot.chi))
)

# Extract eigenvalues
eigenvalues <- data.frame(
  Axis = c(paste0("RDA", 1:length(rda_model$CCA$eig)), paste0("PC", 1:length(rda_model$CA$eig))),
  Eigenvalue = c(rda_model$CCA$eig, rda_model$CA$eig),
  Proportion = c(rda_model$CCA$eig / sum(rda_model$tot.chi), rda_model$CA$eig / sum(rda_model$tot.chi)),
  Cumulative = c(cumsum(rda_model$CCA$eig) / sum(rda_model$tot.chi), 
                 (sum(rda_model$CCA$eig) + cumsum(rda_model$CA$eig)) / sum(rda_model$tot.chi))
)

# Print variance partitioning
kable(variance_partition, caption = "Partitioning of Variance in RDA Model") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

```{r fig-eigen-value }
#| label: fig-eigen-value
#| fig-cap: '**Summary of the redundancy analysis (RDA) results at genome level** The table is showing the percentage of variance explained by each axis.'
#| warning: false
#| echo: false

# Assuming rda_model is the result of your RDA analysis
rda_summary <- summary(rda_model)

# Eigenvalues (variance explained by each axis)
eigenvalues <- rda_summary$cont$importance[2, ]

# Variance explained (percent) by each axis
variance_explained <- round(eigenvalues * 100, 2)

# Coefficients of environmental variables
env_vars_coeff <- rda_summary$biplot

# Combine into a data frame for table display
rda_summary_table <- data.frame(
  Axis = names(variance_explained),
  "Variance Explained (%)" = variance_explained,
  row.names = NULL
)

# Use kable to create a nice summary table
kable(rda_summary_table[1:6,], caption = "Summary of RDA Results: Variance Explained by Each Axis")
```

##### RDA rhodopsin level

```{r fig-anova-rda-rhodopsin-table }
#| label: fig-anova-rda-rhodopsin-table
#| warning: false
#| fig-cap: '**ANOVA results for the redundancy analysis (RDA) at rhodopsin level:** Permutation test (999 permutations) was used to assess the significance of each constrained axis. Significant axes (p < 0.05) indicate that they explain a meaningful portion of the variation in the dataset.'
#| echo: false
# Check if the model is significant
# Example ANOVA results (assuming `rhodopsin.rda_model` is your model)
anova_results <- anova(rhodopsin.rda_model, by = "axis", permutations = 999)

# Convert to a data frame for kable formatting
anova_df <- as.data.frame(anova_results)

# Use kable to format the table
kable(anova_df, caption = "ANOVA Results for RDA Model (Permutation Test)", 
      col.names = c("Axis", "Df", "Variance", "F-Value", "Pr(>F)"), 
      digits = c(0, 0, 4, 4, 4))  # Adjust number of decimals as needed

```

```{r fig-summary-rda-rhodopsin }
#| label: fig-summary-rda-rhodopsin
#| warning: false
#| fig-cap: '**Partitioning of variance in the redundancy analysis (RDA) model at rhodopsin level: ** The table is showing the total inertia (variance), the proportion explained by constrained (predictor-associated) components, and the residual (unconstrained) variance. Higher constrained variance indicates a stronger explanatory power of the selected environmental variables.'
#| echo: false
# Example summary of the RDA model
# Extract variance partitioning

rhodopsin.variance_partition <- data.frame(
  Component = c("Total", "Constrained", "Unconstrained"),
  Inertia = c(sum(rhodopsin.rda_model$tot.chi), sum(rhodopsin.rda_model$CCA$eig), sum(rhodopsin.rda_model$CA$eig)),
  Proportion = c(1, sum(rhodopsin.rda_model$CCA$eig) / sum(rhodopsin.rda_model$tot.chi), sum(rhodopsin.rda_model$CA$eig) / sum(rhodopsin.rda_model$tot.chi))
)

# Extract eigenvalues
rhodopsin.eigenvalues <- data.frame(
  Axis = c(paste0("RDA", 1:length(rhodopsin.rda_model$CCA$eig)), paste0("PC", 1:length(rhodopsin.rda_model$CA$eig))),
  Eigenvalue = c(rhodopsin.rda_model$CCA$eig, rhodopsin.rda_model$CA$eig),
  Proportion = c(rhodopsin.rda_model$CCA$eig / sum(rhodopsin.rda_model$tot.chi), rhodopsin.rda_model$CA$eig / sum(rhodopsin.rda_model$tot.chi)),
  Cumulative = c(cumsum(rhodopsin.rda_model$CCA$eig) / sum(rhodopsin.rda_model$tot.chi), 
                 (sum(rhodopsin.rda_model$CCA$eig) + cumsum(rhodopsin.rda_model$CA$eig)) / sum(rhodopsin.rda_model$tot.chi))
)

# Print variance partitioning
kable(rhodopsin.variance_partition, caption = "Partitioning of Variance in RDA Model") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

```

```{r fig-eigen-value-rhodopsin }
#| label: fig-eigen-value-rhodopsin
#| fig-cap: '**Summary of the redundancy analysis (RDA) results at rhodopsin level** The table is showing the percentage of variance explained by each axis.'
#| warning: false
#| echo: false

# Assuming rda_model is the result of your RDA analysis
prd.rda_summary <- summary(rhodopsin.rda_model)

# Eigenvalues (variance explained by each axis)
prd.eigenvalues <- prd.rda_summary$cont$importance[2, ]

# Variance explained (percent) by each axis
prd.variance_explained <- round(prd.eigenvalues * 100, 2)

# Coefficients of environmental variables
prd.env_vars_coeff <- prd.rda_summary$biplot

# Combine into a data frame for table display
prd.rda_summary_table <- data.frame(
  Axis = names(prd.variance_explained),
  "Variance Explained (%)" = prd.variance_explained,
  row.names = NULL
)

# Use kable to create a nice summary table
kable(prd.rda_summary_table[1:6,], caption = "Summary of RDA Results: Variance Explained by Each Axis")
```

# R and packages

This analysis was run with `r R.version$version.string`. Versions of packages used can be found in @tbl-cite-packages.

```{r tbl-cite-packages}
#| label: tbl-cite-packages
#| cache: false
#| echo: false
#| tbl-cap: Versions of R and packages used in this analysis.

cite_packages(output = "table", pkgs = "Session", out.dir = getwd()) %>%
  kable()
```
